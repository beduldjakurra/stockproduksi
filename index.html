<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PT Fuji Seat Indonesia - Laporan Produksi</title>
    
    <!-- Meta Tags PWA -->
    <meta name="theme-color" content="#4361ee">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fuji Seat Laporan">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Fuji Seat Laporan">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons PWA - Optimized Loading -->
    <link rel="preload" href="icons/icon-192x192.png" as="image" type="image/png">
    <link rel="preload" href="icons/icon-512x512.png" as="image" type="image/png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png">
    
    <!-- Performance Optimization -->
    <script>
        // Early icon performance optimization
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                const icons = ['/icons/icon-192x192.png', '/icons/icon-512x512.png'];
                icons.forEach(src => {
                    const link = document.createElement('link');
                    link.rel = 'prefetch';
                    link.href = src;
                    document.head.appendChild(link);
                });
            });
        }
    </script>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Icon Performance Optimizer -->
    <script src="icon-optimizer.js" defer=""></script>
    
    <!-- Performance Monitoring (Development) -->
    <script>
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const script = document.createElement('script');
            script.src = 'icon-performance-monitor.js';
            script.defer = true;
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        /* CSS Variables */
        :root {
            /* Warna Utama */
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --primary-light: #4895ef;
            --secondary: #06d6a0;
            --secondary-dark: #05b589;
            --accent: #f72585;
            --danger: #ef476f;
            --danger-dark: #d63d63;
            --warning: #ffd166;
            --info: #118ab2;
            --purple: #8b5cf6;
            --purple-dark: #7c3aed;
            
            /* Warna Netral */
            --dark: #2b2d42;
            --light: #f8f9fa;
            --gray: #8d99ae;
            --gray-light: #edf2f4;
            --border-color: #dee2e6;
            
            /* Tema Gelap - PERUBAHAN: Background hitam pekat */
            --dark-bg: #000000;
            --dark-surface: #0a0a0a;
            --dark-text: #e4e6eb;
            --dark-border: rgba(255, 255, 255, 0.15);
            
            /* Spasi & Ukuran - PERBAIKAN: Ukuran font yang lebih konsisten */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            
            /* Typography - PERBAIKAN: Ukuran font yang lebih konsisten */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 16px; /* PERBAIKAN: Font size dasar yang jelas */
            --font-size-sm: calc(var(--font-size-base) * 0.875); /* 14px */
            --font-size-base-rem: 1.1rem;
            --font-size-lg: calc(var(--font-size-base) * 1.125); /* 18px */
            --font-size-xl: calc(var(--font-size-base) * 1.25); /* 20px */
            --font-size-2xl: calc(var(--font-size-base) * 1.5); /* 24px */
            --font-size-3xl: calc(var(--font-size-base) * 1.75); /* 28px */
            --font-size-4xl: calc(var(--font-size-base) * 2); /* 32px */
            --line-height-base: 1.5; /* PERBAIKAN: Line height yang konsisten */
            --line-height-heading: 1.2;
            
            /* Transisi */
            --transition: all 0.3s ease;
        }
        
        /* Reset & Global Styles - PERBAIKAN: CSS Reset yang lebih baik */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: var(--font-size-base); /* PERBAIKAN: Font size dasar yang jelas */
            line-height: var(--line-height-base);
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizeLegibility; /* PERBAIKAN: Font rendering yang lebih baik */
        }
        
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base-rem);
            line-height: var(--line-height-base);
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: var(--spacing-sm);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale; /* PERBAIKAN: Font rendering untuk Firefox */
        }
        
        body.night-mode {
            background: var(--dark-bg); /* PERUBAHAN: Background hitam pekat */
            color: var(--dark-text);
        }
        
        /* Cover Screen - PERBAIKAN: Tampilan lebih menarik dengan background gambar */
        .cover-screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow: hidden;
            /* Ganti background dengan gambar Fuji Mount */
            background-image: url('https://z-cdn-media.chatglm.cn/files/616a6d91-ad77-42da-8d35-36d1d0962d5d_pasted_image_1761051886736.jpg?auth_key=1792587963-0b971709a6b04a6db43c25091270d85c-0-99e88de3d4ec9b4c7686adca602d730d');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .cover-screen::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* Overlay gelap untuk kontras teks */
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .cover-screen.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            animation: fadeInUp 0.8s ease forwards;
            z-index: 1; /* Pastikan di atas overlay */
        }
        
        .logo-image {
            width: 200px;
            height: 200px;
            background-image: url('https://z-cdn-media.chatglm.cn/files/69f99746-a6e5-4c67-8736-aa794f5a64aa_logo1.png?auth_key=1789873019-ba71f0ed107b47f99393be8734b708f4-0-e8e8d6d8a8cc00a3fa694ba0b32dcd1d');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0 auto var(--spacing-lg);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }
        
        .logo {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: white;
            margin-bottom: var(--spacing-sm);
            text-shadow: 0 2px 10px rgba(0,0,0,0.5); /* Tambah bayangan untuk keterbacaan */
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: var(--font-size-lg);
            color: rgba(255,255,255,0.95); /* Putih dengan sedikit transparansi */
            max-width: 600px;
            line-height: var(--line-height-base);
            font-weight: 400;
            text-shadow: 0 1px 5px rgba(0,0,0,0.5); /* Tambah bayangan untuk keterbacaan */
        }
        
        /* Buttons - PERBAIKAN: Tampilan lebih menarik */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: var(--font-size-base-rem);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            z-index: 1;
            -webkit-tap-highlight-color: transparent;
            transition: var(--transition);
        }
        
        .btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .btn:hover::before {
            transform: translateX(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .enter-button {
            background: rgba(255,255,255,0.2); /* Semi-transparan untuk kontras */
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: var(--font-size-lg);
            border-radius: 50px;
            font-weight: 600;
            letter-spacing: 1px;
            backdrop-filter: blur(10px);
            transition: var(--transition);
            animation: fadeInUp 0.8s ease 0.3s both;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3); /* Tambah bayangan untuk keterbacaan */
            z-index: 1; /* Pastikan di atas overlay */
        }
        
        .enter-button:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.7);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .enter-button i {
            transition: transform 0.3s ease;
        }
        
        .enter-button:hover i {
            transform: translateX(3px);
        }
        
        /* Main App - PERBAIKAN: Tampilan lebih menarik */
        .main-app {
            display: none;
            width: 100%;
            max-width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        .container {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: var(--transition);
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        body.night-mode .container {
            background: var(--dark-surface); /* PERUBAHAN: Background hitam pekat untuk container */
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        /* Header & Navigasi - PERBAIKAN: Tampilan lebih menarik */
        header {
            padding: var(--spacing-lg);
            background: white;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            position: relative;
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        body.night-mode header {
            background: var(--dark-surface); /* PERUBAHAN: Background hitam pekat untuk header */
            border-bottom: 1px solid var(--dark-border);
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
        }
        
        h1 {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--spacing-lg);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            text-align: center;
            position: relative;
            line-height: var(--line-height-heading); /* PERBAIKAN: Line height untuk heading */
        }
        
        h1::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }
        
        body.night-mode h1 {
            color: var(--primary-light);
        }
        
        .date {
            color: var(--gray);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-base-rem);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        
        .date::before {
            content: "\f073";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }
        
        body.night-mode .date {
            color: var(--gray-light);
        }
        
        /* Sync Status - PERBAIKAN: Tampilan lebih menarik */
        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }

        body.night-mode .sync-status {
            background: rgba(255,255,255,0.05);
            color: var(--gray-light);
        }

        .sync-status:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .sync-status.syncing {
            color: var(--info);
        }

        .sync-status.synced {
            color: var(--secondary);
        }

        .sync-status.error {
            color: var(--danger);
        }

        .sync-status i {
            animation: spin 2s linear infinite;
        }

        .sync-status.synced i,
        .sync-status.error i {
            animation: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mode Toggle - PERBAIKAN: Tampilan lebih menarik */
        .mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--gray-light);
            border-radius: var(--radius-sm);
            transition: var(--transition);
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        body.night-mode .mode-toggle {
            background: rgba(255,255,255,0.05);
        }
        
        .mode-toggle .mode-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-weight: 500;
            color: var(--dark);
            transition: var(--transition);
        }
        
        body.night-mode .mode-toggle .mode-label {
            color: var(--dark-text);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 34px;
            transition: var(--transition);
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: var(--transition);
        }
        
        input:checked + .slider {
            background: linear-gradient(90deg, var(--info), #0d7ea0);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        /* Tabel - PERBAIKAN: Tampilan lebih menarik */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            position: relative;
            background: white;
            border: 1px solid var(--border-color);
            margin-bottom: var(--spacing-lg);
            -webkit-overflow-scrolling: touch;
            min-width: 100%;
            width: 100%;
            max-width: 100%;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--gray-light);
        }
        
        body.night-mode .table-container {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--dark-border);
            scrollbar-color: var(--primary-light) var(--dark-border);
        }
        
        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 4px;
        }
        
        body.night-mode .table-container::-webkit-scrollbar-track {
            background: var(--dark-border);
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        body.night-mode .table-container::-webkit-scrollbar-thumb {
            background: var(--primary-light);
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        body.night-mode .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
            table-layout: fixed; /* PERBAIKAN: Table layout yang konsisten */
        }
        
        caption {
            font-weight: 700;
            font-size: var(--font-size-lg);
            text-align: left;
            padding: var(--spacing-md);
            color: var(--primary);
            caption-side: top;
            position: relative;
        }
        
        caption::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 2px;
            background: var(--primary);
        }
        
        body.night-mode caption {
            color: var(--primary-light);
        }
        
        th, td {
            padding: var(--spacing-sm);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            min-width: 100px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-family: var(--font-family);
            font-size: 1.1rem;
            transition: var(--transition);
        }
        
        body.night-mode th, 
        body.night-mode td {
            border-bottom: 1px solid var(--dark-border);
        }
        
        th {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            font-weight: 600;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 1.1rem;
            min-width: 120px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        body.night-mode th {
            background: linear-gradient(135deg, var(--info), #0d7ea0);
        }
        
        tr:hover {
            background: rgba(67, 97, 238, 0.05);
        }
        
        body.night-mode tr:hover {
            background: rgba(67, 97, 238, 0.1);
        }
        
        .kode-inject {
            font-weight: 600;
            text-align: left;
            color: var(--dark);
            font-family: var(--font-family);
            min-width: 150px;
            position: sticky;
            left: 0;
            z-index: 9;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            font-size: 1.1rem;
        }
        
        body.night-mode .kode-inject {
            color: var(--dark-text);
            background: var(--dark-surface); /* PERUBAHAN: Background hitam pekat untuk kode-inject */
        }
        
        /* Input Fields - PERBAIKAN: Tampilan lebih menarik */
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: var(--font-size-base-rem);
            background: white;
            color: var(--dark);
            -webkit-appearance: none;
            -moz-appearance: textfield;
            font-family: var(--font-family);
            transition: var(--transition);
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        body.night-mode input[type="number"], 
        body.night-mode input[type="text"] {
            background: rgba(255,255,255,0.1); /* PERUBAHAN: Background lebih gelap untuk input */
            border: 1px solid var(--dark-border);
            color: var(--dark-text);
        }
        
        input[type="number"]:focus, 
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        body.night-mode input[type="number"]:focus, 
        body.night-mode input[type="text"]:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }
        
        /* Result Cells - PERBAIKAN: Tampilan lebih menarik */
        .result-cell {
            font-weight: 600;
            position: relative;
        }
        
        .positive {
            color: var(--secondary);
            font-weight: 700;
        }
        
        .negative {
            color: var(--danger);
            font-weight: 700;
        }
        
        .zero {
            color: var(--gray);
            font-weight: 600;
        }
        
        /* Navigasi & Action Buttons - PERBAIKAN: Tampilan lebih menarik */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            padding: 0 var(--spacing-lg) var(--spacing-lg);
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        .nav-button {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
            -webkit-tap-highlight-color: transparent;
            transition: var(--transition);
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .nav-button i {
            transition: transform 0.3s ease;
        }
        
        .nav-button:hover i:first-child {
            transform: translateX(-3px);
        }
        
        .nav-button:hover i:last-child {
            transform: translateX(3px);
        }
        
        .nav-button.calculate-button {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
        }
        
        /* Footer - PERBAIKAN: Tampilan lebih menarik */
        .footer {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--gray);
            border-top: 1px solid var(--border-color);
            font-size: var(--font-size-sm);
            position: relative;
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        body.night-mode .footer {
            color: var(--gray-light);
            border-top: 1px solid var(--dark-border);
        }
        
        .footer::before {
            content: "";
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 1px;
        }
        
        /* Tab Container - PERBAIKAN: Tampilan lebih menarik */
        .tab-container {
            display: flex;
            background: var(--gray-light);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            position: relative;
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        .tab-container::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        body.night-mode .tab-container {
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid var(--dark-border);
        }
        
        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            font-size: 1.1rem;
            transition: var(--transition);
        }
        
        .tab::after {
            content: "";
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 0;
            height: 3px;
            background: var(--primary);
            transition: width 0.3s ease;
        }
        
        body.night-mode .tab {
            color: var(--gray-light);
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        body.night-mode .tab:hover {
            color: var(--primary-light);
        }
        
        .tab.active {
            color: var(--primary);
        }
        
        .tab.active::after {
            width: 100%;
        }
        
        body.night-mode .tab.active {
            color: var(--primary-light);
        }
        
        body.night-mode .tab.active::after {
            background: var(--primary-light);
        }
        
        /* Tables Container - PERBAIKAN: Tampilan lebih menarik */
        .tables-container {
            position: relative;
            overflow: hidden;
            min-height: 400px;
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        .table-wrapper {
            padding: var(--spacing-md);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: translateX(100%);
            pointer-events: none;
            overflow-x: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .table-wrapper.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
            position: relative;
        }
        
        /* Import Instruction - PERBAIKAN: Tampilan lebih menarik */
        .import-instruction {
            text-align: center;
            margin: var(--spacing-md) 0;
            padding: var(--spacing-md);
            background-color: rgba(17, 138, 178, 0.1);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            color: var(--info);
            border-left: 4px solid var(--info);
            transition: var(--transition);
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        .import-instruction:hover {
            background-color: rgba(17, 138, 178, 0.15);
            transform: translateX(2px);
        }
        
        body.night-mode .import-instruction {
            background-color: rgba(17, 138, 178, 0.2);
            color: var(--info);
            border-left-color: var(--info);
        }
        
        /* File Input */
        .file-input {
            display: none;
        }
        
        /* Modern Card & Button Styles - PERBAIKAN: Tampilan lebih menarik */
        .modern-card {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }
        
        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        body.night-mode .modern-card {
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-modern {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: var(--font-size-base-rem);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            z-index: 1;
            -webkit-tap-highlight-color: transparent;
            transition: var(--transition);
        }
        
        .btn-modern::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .btn-modern:hover::before {
            transform: translateX(0);
        }
        
        .btn-modern-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-modern-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-modern-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-modern-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-modern-purple {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-modern-purple:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Table Modern - PERBAIKAN: Tampilan lebih menarik */
        .table-modern {
            border-radius: var(--radius-sm);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        .table-modern thead th {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: var(--spacing-md);
            text-align: center;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 1.1rem;
            min-width: 120px;
            position: relative;
        }
        
        .table-modern thead th::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: rgba(255,255,255,0.2);
        }
        
        .table-modern tbody tr:nth-child(even) {
            background: rgba(67, 97, 238, 0.03);
        }
        
        body.night-mode .table-modern tbody tr:nth-child(even) {
            background: rgba(67, 97, 238, 0.08);
        }
        
        .table-modern td {
            padding: var(--spacing-md);
            border: none;
            border-bottom: 1px solid var(--border-color);
            min-width: 100px;
            font-size: 1.1rem;
        }
        
        body.night-mode .table-modern td {
            border-bottom: 1px solid var(--dark-border);
        }
        
        /* Badge - PERBAIKAN: Tampilan lebih menarik */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .badge:hover {
            transform: scale(1.05);
        }
        
        .badge-success {
            background: rgba(6, 214, 160, 0.15);
            color: var(--secondary-dark);
        }
        
        .badge-warning {
            background: rgba(255, 209, 102, 0.15);
            color: var(--warning-dark);
        }
        
        .badge-danger {
            background: rgba(239, 71, 111, 0.15);
            color: var(--danger-dark);
        }
        
        body.night-mode .badge-success {
            background: rgba(6, 214, 160, 0.25);
            color: var(--secondary);
        }
        
        body.night-mode .badge-warning {
            background: rgba(255, 209, 102, 0.25);
            color: var(--warning);
        }
        
        body.night-mode .badge-danger {
            background: rgba(239, 71, 111, 0.25);
            color: var(--danger);
        }
        
        /* Input Modern - PERBAIKAN: Tampilan lebih menarik */
        .input-modern {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base-rem);
            background: white;
            color: var(--dark);
            width: 100%;
            transition: var(--transition);
        }
        
        body.night-mode .input-modern {
            background: rgba(255, 255, 255, 0.1); /* PERUBAHAN: Background lebih gelap untuk input-modern */
            border: 1px solid var(--dark-border);
            color: var(--dark-text);
        }
        
        .input-modern:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        body.night-mode .input-modern:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }
        
        /* Section Title - PERBAIKAN: Tampilan lebih menarik */
        .section-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-light);
            display: inline-block;
            position: relative;
            line-height: var(--line-height-heading); /* PERBAIKAN: Line height untuk heading */
        }
        
        .section-title::after {
            content: "";
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 30%;
            height: 2px;
            background: var(--secondary);
        }
        
        body.night-mode .section-title {
            color: var(--primary-light);
            border-bottom: 2px solid var(--primary);
        }
        
        /* Action Button Specific - PERBAIKAN: Tampilan lebih menarik */
        .action-button.save {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
        }
        
        .action-button.jpg-share {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: white;
        }
        
        .action-button.import {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .action-button.reset {
            background: linear-gradient(135deg, var(--danger), var(--danger-dark));
            color: white;
        }
        
        .action-button {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-md);
            -webkit-tap-highlight-color: transparent;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .action-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .action-button:hover::before {
            transform: translateX(0);
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .action-button i {
            transition: transform 0.3s ease;
        }
        
        .action-button:hover i {
            transform: scale(1.1);
        }
        
        /* Third Page Import */
        #thirdPageImport {
            margin-top: var(--spacing-md);
            width: 100%; /* PERBAIKAN: Lebar yang jelas */
        }
        
        /* Progress Bar - PERBAIKAN: Tampilan lebih menarik */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            width: 0;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
            transition: width 0.3s ease;
        }
        
        /* Modal - PERBAIKAN: Tampilan lebih menarik */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        body.night-mode .modal-content {
            background: var(--dark-surface); /* PERUBAHAN: Background hitam pekat untuk modal */
        }
        
        .modal.active .modal-content {
            transform: scale(1);
        }
        
        .modal-content h3 {
            margin-bottom: var(--spacing-md);
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .modal-content p {
            margin-bottom: var(--spacing-lg);
            color: var(--dark);
        }
        
        body.night-mode .modal-content p {
            color: var(--dark-text);
        }
        
        .modal-buttons {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
        }
        
        .modal-button {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .modal-button.cancel {
            background: var(--gray-light);
            color: var(--dark);
        }
        
        .modal-button.cancel:hover {
            background: var(--gray);
            color: white;
        }
        
        .modal-button.confirm {
            background: var(--danger);
            color: white;
        }
        
        .modal-button.confirm:hover {
            background: var(--danger-dark);
        }
        
        /* Toast Notification - PERBAIKAN: Tampilan lebih menarik */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: var(--spacing-sm);
            max-width: 90%;
            transition: var(--transition);
        }
        
        .toast.error {
            background: var(--danger);
        }
        
        .toast.show {
            display: flex;
            animation: slideUp 0.3s ease forwards;
        }
        
        /* Offline Indicator - PERBAIKAN: Tampilan lebih menarik */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--danger);
            color: white;
            text-align: center;
            padding: var(--spacing-sm);
            z-index: 1001;
            display: none;
            font-weight: 600;
            font-size: var(--font-size-sm);
            box-shadow: var(--shadow-md);
            animation: fadeInDown 0.3s ease;
        }
        
        /* Offline Page - PERBAIKAN: Tampilan lebih menarik */
        .offline-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1f2e 0%, #252b3b 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            text-align: center;
            padding: var(--spacing-lg);
        }
        
        .offline-page.hidden {
            display: none;
        }
        
        .offline-icon {
            font-size: 4rem;
            color: var(--danger);
            margin-bottom: var(--spacing-lg);
            animation: pulse 2s infinite;
        }
        
        .offline-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
        }
        
        .offline-message {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xl);
            max-width: 600px;
        }
        
        .offline-button {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            font-size: var(--font-size-lg);
            transition: var(--transition);
        }
        
        .offline-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* Error Modal - PERBAIKAN: Tampilan lebih menarik */
        .error-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .error-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .error-modal-content {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        body.night-mode .error-modal-content {
            background: var(--dark-surface); /* PERUBAHAN: Background hitam pekat untuk error-modal */
        }
        
        .error-modal.active .error-modal-content {
            transform: scale(1);
        }
        
        .error-icon {
            font-size: 3rem;
            color: var(--danger);
            margin-bottom: var(--spacing-md);
            animation: shake 0.5s ease;
        }
        
        .error-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--danger);
            margin-bottom: var(--spacing-md);
        }
        
        .error-message {
            font-size: var(--font-size-base-rem);
            margin-bottom: var(--spacing-lg);
            color: var(--dark);
        }
        
        body.night-mode .error-message {
            color: var(--dark-text);
        }
        
        .error-details {
            font-size: var(--font-size-sm);
            color: var(--gray);
            margin-bottom: var(--spacing-lg);
            text-align: left;
            background: var(--gray-light);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            max-height: 150px;
            overflow-y: auto;
        }
        
        body.night-mode .error-details {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gray-light);
        }
        
        .error-button {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .error-button:hover {
            background: var(--primary-dark);
        }
        
        /* Loading Spinner - PERBAIKAN: Tampilan lebih menarik */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-xs);
            }
            
            .container {
                border-radius: var(--radius-sm);
            }
            
            header {
                padding: var(--spacing-md);
            }
            
            h1 {
                font-size: var(--font-size-3xl);
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: center;
            }
            
            .logo {
                font-size: var(--font-size-2xl);
            }
            
            .logo-subtitle {
                font-size: var(--font-size-base-rem);
            }
            
            .enter-button {
                padding: var(--spacing-sm) var(--spacing-lg);
                font-size: var(--font-size-base-rem);
            }
            
            .action-buttons {
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            
            .action-button {
                width: 100%;
                padding: var(--spacing-md);
                font-size: var(--font-size-base-rem);
            }
            
            .nav-buttons {
                padding: 0 var(--spacing-md) var(--spacing-md);
            }
            
            th, td {
                padding: var(--spacing-xs);
                min-width: 80px;
                font-size: 1.05rem;
            }
            
            .kode-inject {
                font-size: 1.05rem;
            }
        }
        
        @media (max-width: 576px) {
            /* Mode toggle untuk mobile */
            .mode-toggle {
                flex-direction: row;
                justify-content: space-between;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm);
            }
            
            .mode-toggle .mode-label {
                font-size: var(--font-size-sm);
            }
            
            .mode-toggle .mode-label i {
                font-size: var(--font-size-base-rem);
            }
            
            .toggle-switch {
                width: 50px;
                height: 25px;
            }
            
            .slider:before {
                height: 18px;
                width: 18px;
                left: 3.5px;
                bottom: 3.5px;
            }
            
            input:checked + .slider:before {
                transform: translateX(25px);
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .tab {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 1rem;
            }
            
            h1 {
                font-size: var(--font-size-2xl);
            }
            
            .action-button {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .action-button i {
                font-size: 0.9rem;
            }
            
            /* Perubahan utama: Hanya sembunyikan teks untuk tombol tertentu */
            .action-button:not(.save):not(.jpg-share):not(.import):not(.reset) span {
                display: none;
            }
            
            /* Pertahankan teks untuk tombol penting */
            .action-button.save span,
            .action-button.jpg-share span,
            .action-button.import span,
            .action-button.reset span {
                display: inline;
                font-size: 0.75rem;
            }
            
            /* Sesuaikan padding untuk tombol dengan teks */
            .action-button.save,
            .action-button.jpg-share,
            .action-button.import,
            .action-button.reset {
                padding: 10px 8px;
                min-width: auto;
            }
            
            /* Sembunyikan tooltip untuk tombol dengan teks */
            .action-button.save::after,
            .action-button.jpg-share::after,
            .action-button.import::after,
            .action-button.reset::after {
                display: none;
            }
            
            /* Pertahankan tooltip untuk tombol lainnya */
            .action-button:not(.save):not(.jpg-share):not(.import):not(.reset)::after {
                content: attr(data-title);
                position: absolute;
                bottom: -30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.7rem;
                white-space: nowrap;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .action-button:not(.save):not(.jpg-share):not(.import):not(.reset):hover::after {
                opacity: 1;
            }
            
            /* Styling untuk tabel mobile */
            .table-wrapper {
                padding: 0;
                width: 100%;
                margin: 0;
                overflow-x: hidden;
            }
            
            .table-container {
                width: 100%;
                overflow-x: auto;
                margin: 0;
                border-radius: 0;
                border-left: none;
                border-right: none;
                -webkit-overflow-scrolling: touch;
            }
            
            .tables-container {
                margin: 0;
                padding: 0;
                width: 100%;
                overflow: hidden;
            }
            
            th, td {
                min-width: 70px;
                padding: 6px;
                font-size: 1rem;
            }
            
            .kode-inject {
                min-width: 100px;
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                gap: 8px;
            }
            
            .action-button {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .action-button i {
                font-size: 0.9rem;
            }
            
            h1 {
                font-size: var(--font-size-xl);
                flex-direction: row;
                gap: 5px;
                align-items: center;
                padding: 5px 0;
            }
            
            h1 i {
                font-size: 1.2rem;
                margin-right: 5px;
            }
            
            /* Ukuran kolom KODE INJECT pada tabel kedua lebih kecil */
            #secondTable .kode-inject {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
                font-size: 0.9rem;
                padding: 6px 4px;
            }
            
            #secondTable th:first-child {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
                padding: 6px 4px;
                font-size: 0.9rem;
            }
        }
        
        /* Utilities */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        .animate-up {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .delay-1 {
            animation-delay: 0.1s;
        }
        
        .delay-2 {
            animation-delay: 0.2s;
        }
        
        .delay-3 {
            animation-delay: 0.3s;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Custom CSS untuk menyembunyikan notifikasi yang menghalangi tabel */
        .progress-bar {
            display: none !important;
        }
        
        .offline-indicator {
            display: none !important;
        }
        
        .toast {
            display: none !important;
        }
        
        .sync-status {
            display: none !important;
        }
        
        /* Pastikan tabel tetap terlihat penuh tanpa halangan */
        .table-container {
            z-index: 1 !important;
            position: relative !important;
        }
        
        .tables-container {
            z-index: 1 !important;
            position: relative !important;
        }
        
        /* Mengurangi padding pada container untuk memberikan lebih banyak ruang untuk tabel */
        .container {
            padding: 0 !important;
        }
        
        header {
            padding: 10px !important;
        }
        
        footer {
            padding: 10px !important;
        }
        
        /* Menghilangkan border dan shadow yang mungkin mengganggu */
        .table-container {
            border: none !important;
            box-shadow: none !important;
            margin-bottom: 5px !important;
        }
        
        /* PERBAIKAN: Styling untuk capture gambar */
        .capture-wrapper {
            background-color: white;
            padding: 20px;
            font-family: var(--font-family);
            color: var(--dark);
            width: 100%;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        
        body.night-mode .capture-wrapper {
            background-color: var(--dark-surface);
            color: var(--dark-text);
        }
        
        .capture-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            background-color: white;
        }
        
        .capture-header h1 {
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .capture-header h2 {
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .capture-header h3 {
            color: var(--gray);
            margin-bottom: 5px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .capture-header p {
            color: var(--gray);
            font-size: 14px;
        }
        
        body.night-mode .capture-header h1 {
            color: var(--primary-light);
        }
        
        body.night-mode .capture-header h2 {
            color: var(--dark-text);
        }
        
        body.night-mode .capture-header h3,
        body.night-mode .capture-header p {
            color: var(--gray-light);
        }
        
        .capture-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: white;
            table-layout: fixed;
        }
        
        .capture-table th {
            background-color: var(--primary);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            border: 1px solid var(--primary);
        }
        
        .capture-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 18px;
            border: 1px solid #dee2e6;
            background-color: white;
        }
        
        body.night-mode .capture-table th {
            background-color: var(--info);
        }
        
        body.night-mode .capture-table td {
            border-bottom: 1px solid var(--dark-border);
        }
        
        .capture-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--gray);
            background-color: white;
        }
        
        body.night-mode .capture-footer {
            border-top: 1px solid var(--dark-border);
            color: var(--gray-light);
        }
        
        /* Header sticky */
        th:first-child {
            position: sticky;
            left: 0;
            z-index: 11;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        
        body.night-mode th:first-child {
            background: linear-gradient(135deg, var(--info), #0d7ea0);
        }
        
        /* Perubahan untuk membuat header KODE INJECT pada tabel kedua sama dengan tabel pertama */
        #secondTable th:first-child {
            padding: var(--spacing-sm);
            font-weight: 600;
            color: white;
            position: sticky;
            left: 0;
            z-index: 11;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 1.1rem;
            min-width: 120px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        
        body.night-mode #secondTable th:first-child {
            background: linear-gradient(135deg, var(--info), #0d7ea0);
        }
        
        /* Perubahan untuk membuat header KODE INJECT pada tabel ketiga sama dengan tabel pertama */
        #thirdTable th:first-child {
            padding: var(--spacing-sm);
            font-weight: 600;
            color: white;
            position: sticky;
            left: 0;
            z-index: 11;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 1.1rem;
            min-width: 120px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        
        body.night-mode #thirdTable th:first-child {
            background: linear-gradient(135deg, var(--info), #0d7ea0);
        }
        
        /* PERBAIKAN: Browser-specific fixes */
        /* Firefox-specific fixes */
        @-moz-document url-prefix() {
            body {
                font-weight: 400; /* Mengatasi font yang terlalu tebal di Firefox */
            }
            
            .table-container {
                font-size: 0.95em; /* Menyesuaikan ukuran font di Firefox */
            }
            
            input, button {
                font-size: 1em; /* Konsistensi ukuran font di Firefox */
            }
            
            .action-button {
                min-height: 44px; /* Touch target size yang cukup di Firefox */
            }
        }
        
        /* Chrome/Safari-specific fixes */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            input, textarea, button {
                -webkit-font-smoothing: antialiased;
                -webkit-appearance: none;
            }
            
            .action-button {
                -webkit-transform: translateZ(0); /* Hardware acceleration */
            }
        }
        
        /* Edge-specific fixes */
        @supports (-ms-ime-align: auto) {
            .container {
                display: block; /* Fix for flexbox in Edge */
            }
        }
        
        /* NEW: Table Footer Styles */
        .table-footer {
            background-color: #f8f9fa;
            border-top: 2px solid var(--primary);
            padding: var(--spacing-md);
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--dark);
            margin-top: var(--spacing-md);
        }
        
        body.night-mode .table-footer {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--dark-text);
            border-top: 2px solid var(--primary-light);
        }
        
        .table-footer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .table-footer-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .table-footer-label {
            font-weight: 600;
            color: var(--primary);
        }
        
        body.night-mode .table-footer-label {
            color: var(--primary-light);
        }
        
        .table-footer-value {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progressBar"></div>
    
    <div class="cover-screen" id="coverScreen">
        <div class="logo-container">
            <!-- Logo Image - Tambahan baru -->
            <div class="logo-image"></div>
            <div class="logo">PT FUJI SEAT INDONESIA</div>
            <div class="logo-subtitle">Laporan Data Stock Akhir Proses Div.INJECTION</div>
        </div>
        <button class="enter-button" id="enterButton"><i class="fas fa-arrow-right"></i> MASUK APLIKASI</button>
    </div>
    
    <!-- Offline Page - NEW -->
    <div class="offline-page hidden" id="offlinePage">
        <div class="offline-icon">
            <i class="fas fa-wifi-slash"></i>
        </div>
        <h2 class="offline-title">Anda Sedang Offline</h2>
        <p class="offline-message">
            Aplikasi ini memerlukan koneksi internet untuk berfungsi penuh. 
            Silakan periksa koneksi internet Anda dan coba lagi.
        </p>
        <button class="offline-button" id="retryConnectionButton">
            <i class="fas fa-sync-alt"></i> Coba Lagi
        </button>
    </div>
    
    <!-- Error Modal - NEW -->
    <div class="error-modal" id="errorModal">
        <div class="error-modal-content">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="error-title">Terjadi Kesalahan</h3>
            <p class="error-message" id="errorMessage">Mohon maaf, terjadi kesalahan saat memproses permintaan Anda.</p>
            <div class="error-details" id="errorDetails"></div>
            <button class="error-button" id="errorModalCloseButton">Tutup</button>
        </div>
    </div>
    
    <div class="main-app" id="mainApp">
        <div class="container">
            <header>
                <h1 id="pageTitle">
                    <i class="fas fa-sun" id="modeIcon"></i> STOCK PRODUKSI DAY
                </h1>
                
                <div class="date" id="currentDate"></div>
                
                <!-- Sync Status - NEW -->
                <div class="sync-status" id="syncStatus">
                    <i class="fas fa-sync-alt"></i> <span id="syncStatusText">Sinkronisasi...</span>
                </div>
                
                <!-- Mode Toggle -->
                <div class="mode-toggle animate-up">
                    <div class="mode-label">
                        <i class="fas fa-sun"></i>
                        <span>Day</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modeToggle">
                        <span class="slider"></span>
                    </label>
                    <div class="mode-label">
                        <i class="fas fa-moon"></i>
                        <span>Night</span>
                    </div>
                </div>
                
                <div class="action-buttons animate-up delay-2">
                    <button class="action-button save btn-modern btn-modern-primary" id="saveExcelButton" aria-label="Save to Excel and Share" role="button" tabindex="0" data-title="Save to Excel">
                        <i class="fas fa-file-excel"></i> <span>Save to Excel</span>
                    </button>
                    <button class="action-button jpg-share btn-modern btn-modern-purple" id="shareJpgButton" aria-label="Convert to JPG and Share" role="button" tabindex="0" data-title="Convert to JPG" onclick="ShareManager.captureActiveTable()">
                        <i class="fas fa-image"></i> <span>Convert to JPG</span>
                    </button>
                    <button class="action-button import btn-modern btn-modern-primary" id="importExcelButton" aria-label="Import Excel" role="button" tabindex="0" data-title="Import Excel">
                        <i class="fas fa-file-import"></i> <span>Import Excel</span>
                    </button>
                    <button class="action-button reset btn-modern" id="resetButton" aria-label="Reset Data" role="button" tabindex="0" data-title="Reset Data">
                        <i class="fas fa-redo"></i> <span>Reset Data</span>
                    </button>
                </div>
                
                <div class="import-instruction animate-up hidden">
                    <i class="fas fa-info-circle"></i> Pastikan file Excel memiliki kolom: KODE INJECT, STOCK AWAL, PRODUKSI, SURCIP, SUNTER, KIIC
                </div>
                
                <div class="import-instruction animate-up hidden">
                    <i class="fas fa-info-circle"></i> Pada halaman Perhitungan Box, kolom ACT/BOX dapat diisi dengan format: 10,20,30 (akan otomatis dijumlahkan)
                </div>
                
                <label for="fileInput" class="sr-only">Import Excel File</label>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" aria-label="File Import">
                
                <!-- Tombol Import Khusus untuk Halaman 3 -->
                <div id="thirdPageImport" class="hidden">
                    <div class="import-instruction animate-up hidden">
                        <i class="fas fa-info-circle"></i> Untuk halaman Kekuatan Stock: Pastikan file Excel memiliki kolom: KODE INJECT, STOCK REGULER, ANZEN STOCK, F/C 2D
                    </div>
                    <label for="fileInputThird" class="sr-only">Import Excel File untuk Halaman Kekuatan Stock</label>
                    <input type="file" id="fileInputThird" class="file-input" accept=".xlsx,.xls" aria-label="File Import untuk Halaman Kekuatan Stock">
                </div>
            </header>
            
            <div class="tab-container animate-up">
                <div class="tab active" data-tab="main">Stock Produksi</div>
                <div class="tab" data-tab="second">Perhitungan Box</div>
                <div class="tab" data-tab="third">Kekuatan Stock</div>
            </div>
            
            <div class="tables-container">
                <!-- Tabel 1: Stock Produksi -->
                <div class="table-wrapper active" id="mainTableWrapper">
                    <div class="table-container" id="mainTableContainer">
                        <table id="mainTable" class="table-modern" role="grid" aria-label="Tabel Utama Produksi">
                            <caption>Laporan Stock Produksi</caption>
                            <thead>
                                <tr>
                                    <th scope="col" data-label="Kode Inject" style="font-size: 1.2rem;">KODE INJECT</th>
                                    <th scope="col" data-label="Stock Awal">STOCK AWAL</th>
                                    <th scope="col" data-label="Produksi">PRODUKSI</th>
                                    <th scope="col" data-label="Surcip">SURCIP</th>
                                    <th scope="col" data-label="Sunter">SUNTER</th>
                                    <th scope="col" data-label="KIIC">KIIC</th>
                                    <th scope="col" data-label="ACT QTY">ACT QTY</th>
                                    <th scope="col" data-label="GAP">GAP</th>
                                </tr>
                            </thead>
                            <tbody id="mainTableBody"></tbody>
                            <!-- NEW: Table Footer -->
                            <tfoot>
                                <tr>
                                    <td colspan="8" class="table-footer">
                                        <div class="table-footer-info">
                                            <div class="table-footer-item">
                                                <span class="table-footer-label"><br></span>
                                                <span class="table-footer-value">FM-448 : FJI-PD-38</span>
                                            </div>
                                            <div class="table-footer-item">
                                                <span class="table-footer-label"><br></span>
                                                <span class="table-footer-value">Tanggal : 14-OCT-25</span>
                                            </div>
                                            <div class="table-footer-item">
                                                <span class="table-footer-label"><br></span>
                                                <span class="table-footer-value">No.Revisi : 00&nbsp; &nbsp; &nbsp;Hal : 1/1</span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Tabel 2: Perhitungan Box -->
                <div class="table-wrapper" id="secondTableWrapper">
                    <div class="table-container" id="secondTableContainer">
                        <table id="secondTable" class="table-modern table-2" role="grid" aria-label="Tabel Perhitungan Box">
                            <caption>Perhitungan Box</caption>
                            <thead>
                                <tr>
                                    <th scope="col" data-label="Kode Inject" style="font-size: 1.2rem;">KODE INJECT</th>
                                    <th scope="col" data-label="STDRT PACK">STDRT PACK</th>
                                    <th scope="col" data-label="ACT /BOX">ACT /BOX</th>
                                    <th scope="col" data-label="ACT QTY">ACT QTY</th>
                                </tr>
                            </thead>
                            <tbody id="secondTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tabel 3: Kekuatan Stock -->
                <div class="table-wrapper" id="thirdTableWrapper">
                    <div class="table-container" id="thirdTableContainer">
                        <table id="thirdTable" class="table-modern table-3" role="grid" aria-label="Tabel Kekuatan Stock">
                            <caption>Kekuatan Stock</caption>
                            <thead>
                                <tr>
                                    <th scope="col" data-label="Kode Inject" style="font-size: 1.2rem;">KODE INJECT</th>
                                    <th scope="col" data-label="Stock Reguler">STOCK REGULER</th>
                                    <th scope="col" data-label="Anzen Stock">ANZEN STOCK</th>
                                    <th scope="col" data-label="F/C 2D">F/C 2D</th>
                                    <th scope="col" data-label="Kekuatan Stock /Day">KEKUATAN STOCK /DAY</th>
                                    <th scope="col" data-label="Kekuatan Anzen Stock /Day">KEKUATAN ANZEN STOCK /DAY</th>
                                </tr>
                            </thead>
                            <tbody id="thirdTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="nav-buttons animate-up">
                <button id="prevButton" class="nav-button prev-button hidden" aria-label="Kembali">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
                <button id="nextButton" class="nav-button next-button" aria-label="Selanjutnya">
                    Selanjutnya <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <footer class="footer animate-up">
                <p><i class="far fa-copyright"></i> 2025 Laporan Produksi Harian - PT Fuji Seat Indonesia</p>
            </footer>
        </div>
    </div>
    
    <div class="modal" id="confirmationModal" role="dialog" aria-labelledby="modalTitle">
        <div class="modal-content">
            <h3 id="modalTitle"><i class="fas fa-exclamation-triangle"></i> Konfirmasi</h3>
            <p id="modalMessage">Apakah Anda yakin ingin mereset semua data?</p>
            <div class="modal-buttons">
                <button class="modal-button cancel" id="modalCancelButton" aria-label="Batal">Batal</button>
                <button class="modal-button confirm" id="modalConfirmButton" aria-label="Reset">Ya, Reset</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i> <span id="toastMessage">Operasi berhasil</span>
    </div>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i> Anda sedang offline
    </div>
    
    <script>
        // ===== KONFIGURASI APLIKASI =====
        const APP_CONFIG = {
            maxRetries: 3,
            retryDelay: 1000,
            saveDelay: 2000,
            autoSaveInterval: 30000,
            toastDuration: 3000,
            statusIndicatorDuration: 2000,
            virtualScrollThreshold: Infinity,
            installPromptDelay: 5000,
            offlineCheckInterval: 5000,
            syncInterval: 60000, // 1 minute
            // PERUBAHAN: Konfigurasi untuk JPG yang ditingkatkan
            jpgConfig: {
                maxSize: 2000000, // Diubah dari 1.5MB menjadi 2MB
                initialQuality: 0.95, // Ditingkatkan dari 0.9
                minQuality: 0.5, // Diturunkan untuk fleksibilitas lebih
                scale: 2.5, // Ditingkatkan untuk kualitas lebih baik
                maxScale: 4, // Ditingkatkan untuk fleksibilitas lebih
                minScale: 1,
                maxIterations: 5
            },
            // NEW: Cache configuration
            cacheConfig: {
                cacheName: 'fuji-seat-app-v1',
                cacheUrls: [
                    '/',
                    '/index.html',
                    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                    'icons/icon-192x192.png',
                    'icons/icon-512x512.png'
                ]
            }
        };
        
        // Data konstan aplikasi - DIPERBARUI dengan semua model dari gambar
        const KODE_INJECT = [
            "J-303 RH", "J-305", "J-306 RH", "J-306 LH", "J-307", "J-308 RH", "J-308 LH", 
            "J-309", "J-1401 RH", "J-1402 LH", "J-1403 RH", "J-1403 LH", "J-1404 RH", 
            "J-1404 LH", "J-1405 RH", "J-1405 LH", "J-1406 RH", "J-1406 LH", "J-1407 RH", 
            "J-1407 LH", "J-1408 RH", "J-1408 LH", "J-1409 RH", "J-1409 LH", "J-1410 RH", 
            "J-1411 LH", "J-1412 RH", "J-1413 LH", "J-5501", "J-5502", "J-5503", "J-5504", 
            "J-5505", "J-5506", "J-5508 RH", "J-5508 LH", "J-5509 RH", "J-5509 LH", 
            "J-3701 RH", "J-3701 LH", "J-3702 RH", "J-3702 LH", "136B", "202B"
        ];

        // PERUBAHAN: Standart pack untuk J-3701 RH, J-3701 LH, J-3702 RH, dan J-3702 LH diubah menjadi 12
        // PERUBAHAN: Standart pack untuk 136B dan 202B diubah menjadi 25
        const STDRT_PACK = [
            104, 200, 32, 32, 52, 15, 15, 48, 72, 72, 40, 40, 60, 60, 9, 9, 10, 10, 
            144, 144, 120, 120, 40, 40, 18, 18, 24, 24, 11, 11, 12, 12, 192, 180, 
            200, 200, 24, 24, 12, 12, 12, 12, 25, 25  // PERUBAHAN: 136B dan 202B diubah menjadi 25
        ];

        // Perbarui juga array N untuk mencerminkan jumlah item baru
        const N = KODE_INJECT.length; // Ini akan otomatis menghitung jumlah item
        
        // State aplikasi
        const APP_STATE = {
            currentView: 'main',
            isNightMode: false,
            currentSheet: 1,
            sheetsData: { 1: {}, 2: {} },
            inputValues: {
                stockAwal: {},
                produksi: {},
                surcip: {},
                sunter: {},
                kiic: {},
                actBox: {},
                stockReguler: {},
                anzenStock: {},
                fc2d: {}
            },
            actQtyValues: {},
            gapValues: {},
            kekuatanStockValues: {},
            kekuatanAnzenValues: {},
            autoSaveInterval: null,
            saveTimeout: null,
            useVirtualScroll: false,
            isOnline: navigator.onLine,
            deferredPrompt: null,
            installPromptShown: false,
            syncInterval: null,
            lastSyncTime: null,
            db: null,
            syncStatus: 'synced', // NEW: Track sync status
            syncErrorCount: 0, // NEW: Track sync errors
            // NEW: Cache state
            cacheAvailable: false,
            cacheStatus: 'not-checked'
        };
        
        // Cache elemen DOM
        const DOM = {
            coverScreen: document.getElementById('coverScreen'),
            enterButton: document.getElementById('enterButton'),
            mainApp: document.getElementById('mainApp'),
            mainTableWrapper: document.getElementById('mainTableWrapper'),
            secondTableWrapper: document.getElementById('secondTableWrapper'),
            thirdTableWrapper: document.getElementById('thirdTableWrapper'),
            mainTableContainer: document.getElementById('mainTableContainer'),
            secondTableContainer: document.getElementById('secondTableContainer'),
            thirdTableContainer: document.getElementById('thirdTableContainer'),
            mainTableBody: document.getElementById('mainTableBody'),
            secondTableBody: document.getElementById('secondTableBody'),
            thirdTableBody: document.getElementById('thirdTableBody'),
            prevButton: document.getElementById('prevButton'),
            nextButton: document.getElementById('nextButton'),
            modeToggle: document.getElementById('modeToggle'),
            pageTitle: document.getElementById('pageTitle'),
            currentDate: document.getElementById('currentDate'),
            fileInput: document.getElementById('fileInput'),
            fileInputThird: document.getElementById('fileInputThird'),
            thirdPageImport: document.getElementById('thirdPageImport'),
            container: document.querySelector('.container'),
            progressBar: document.getElementById('progressBar'),
            saveExcelButton: document.getElementById('saveExcelButton'),
            shareJpgButton: document.getElementById('shareJpgButton'),
            importExcelButton: document.getElementById('importExcelButton'),
            resetButton: document.getElementById('resetButton'),
            modalCancelButton: document.getElementById('modalCancelButton'),
            modalConfirmButton: document.getElementById('modalConfirmButton'),
            tabs: document.querySelectorAll('.tab'),
            modeIcon: document.getElementById('modeIcon'),
            offlineIndicator: document.getElementById('offlineIndicator'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toastMessage'),
            confirmationModal: document.getElementById('confirmationModal'),
            // NEW: Sync status elements
            syncStatus: document.getElementById('syncStatus'),
            syncStatusText: document.getElementById('syncStatusText'),
            // NEW: Offline page elements
            offlinePage: document.getElementById('offlinePage'),
            retryConnectionButton: document.getElementById('retryConnectionButton'),
            // NEW: Error modal elements
            errorModal: document.getElementById('errorModal'),
            errorMessage: document.getElementById('errorMessage'),
            errorDetails: document.getElementById('errorDetails'),
            errorModalCloseButton: document.getElementById('errorModalCloseButton'),
            // NEW: Table footer elements
            tableFooterDate: document.getElementById('tableFooterDate')
        };
        
        // ===== SERVICE WORKER REGISTRATION =====
        const ServiceWorkerManager = {
            register: async () => {
                if ('serviceWorker' in navigator) {
                    try {
                        // Create service worker content
                        const swContent = `
                            const CACHE_NAME = '${APP_CONFIG.cacheConfig.cacheName}';
                            const URLS_TO_CACHE = ${JSON.stringify(APP_CONFIG.cacheConfig.cacheUrls)};
                            
                            self.addEventListener('install', event => {
                                event.waitUntil(
                                    caches.open(CACHE_NAME)
                                        .then(cache => {
                                            console.log('Opened cache');
                                            return cache.addAll(URLS_TO_CACHE);
                                        })
                                        .catch(error => {
                                            console.error('Cache add all failed:', error);
                                        })
                                );
                            });
                            
                            self.addEventListener('activate', event => {
                                event.waitUntil(
                                    caches.keys().then(cacheNames => {
                                        return Promise.all(
                                            cacheNames.map(cacheName => {
                                                if (cacheName !== CACHE_NAME) {
                                                    return caches.delete(cacheName);
                                                }
                                            })
                                        );
                                    })
                                );
                            });
                            
                            self.addEventListener('fetch', event => {
                                event.respondWith(
                                    caches.match(event.request)
                                        .then(response => {
                                            if (response) {
                                                return response;
                                            }
                                            return fetch(event.request).catch(error => {
                                                console.error('Fetch failed:', error);
                                                // Return offline page for HTML requests
                                                if (event.request.headers.get('accept').includes('text/html')) {
                                                    return caches.match('/offline.html');
                                                }
                                                throw error;
                                            });
                                        })
                                        .catch(error => {
                                            console.error('Cache match failed:', error);
                                            return fetch(event.request);
                                        })
                                );
                            });
                        `;
                        
                        // Create blob from service worker content
                        const blob = new Blob([swContent], { type: 'application/javascript' });
                        const swUrl = URL.createObjectURL(blob);
                        
                        // Register service worker
                        const registration = await navigator.serviceWorker.register(swUrl);
                        console.log('Service Worker registered with scope:', registration.scope);
                        
                        // Update cache status
                        APP_STATE.cacheAvailable = true;
                        APP_STATE.cacheStatus = 'registered';
                        
                        return registration;
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                        APP_STATE.cacheStatus = 'failed';
                        return null;
                    }
                } else {
                    console.log('Service Worker not supported');
                    APP_STATE.cacheStatus = 'not-supported';
                    return null;
                }
            },
            
            checkCacheStatus: () => {
                if ('caches' in window) {
                    caches.open(APP_CONFIG.cacheConfig.cacheName)
                        .then(cache => {
                            APP_STATE.cacheAvailable = true;
                            APP_STATE.cacheStatus = 'available';
                            console.log('Cache is available');
                        })
                        .catch(error => {
                            console.error('Cache not available:', error);
                            APP_STATE.cacheStatus = 'not-available';
                        });
                } else {
                    APP_STATE.cacheStatus = 'not-supported';
                }
            }
        };
        
        // ===== FUNGSI PERHITUNGAN TOTAL =====
        const TotalCalculator = {
            // Fungsi ini sengaja dikosongkan untuk menghilangkan total
            initTotals: () => {
                // Tidak membuat baris total lagi
                return;
            },
            calculateTotals: () => {
                // Fungsi ini sengaja dikosongkan
                return;
            }
        };
        
        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            debounce: (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            },
            validateNumberInput: (value, max = 999999, min = 0) => {
                value = value.replace(/[^0-9]/g, '');
                if (value === '') return '';
                const num = parseInt(value);
                if (isNaN(num)) return '';
                return Math.max(min, Math.min(num, max)).toString();
            },
            validateDecimalInput: (value, max = 999999, min = 0) => {
                value = value.replace(/[^0-9.]/g, '');
                if (value === '') return '';
                const decimalCount = (value.match(/\./g) || []).length;
                if (decimalCount > 1) {
                    value = value.substring(0, value.lastIndexOf('.'));
                }
                const num = parseFloat(value);
                if (isNaN(num)) return '';
                return Math.max(min, Math.min(num, max)).toFixed(2);
            },
            checkLibraryAvailability: (libName, globalVar) => {
                if (typeof globalVar === 'undefined') {
                    console.error(`${libName} library is not loaded.`);
                    AppUI.showToast(`Library ${libName} tidak tersedia. Silakan muat ulang halaman.`, true);
                    return false;
                }
                return true;
            },
            checkOnlineStatus: () => {
                const wasOnline = APP_STATE.isOnline;
                APP_STATE.isOnline = navigator.onLine;
                
                if (APP_STATE.isOnline) {
                    DOM.offlineIndicator.style.display = 'none';
                    
                    // If we just came back online, hide offline page
                    if (DOM.offlinePage && !DOM.offlinePage.classList.contains('hidden')) {
                        DOM.offlinePage.classList.add('hidden');
                        DOM.mainApp.style.display = 'block';
                    }
                    
                    // Try to sync when coming back online
                    if (wasOnline === false && APP_STATE.syncStatus === 'error') {
                        SyncManager.syncData();
                    }
                } else {
                    DOM.offlineIndicator.style.display = 'block';
                    SyncManager.updateStatus('error', 'Anda sedang offline');
                    
                    // Show offline page if we're in main app
                    if (DOM.mainApp.style.display !== 'none') {
                        DOM.mainApp.style.display = 'none';
                        if (DOM.offlinePage) {
                            DOM.offlinePage.classList.remove('hidden');
                        }
                    }
                }
            },
            generateId: () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            formatDate: (date) => {
                return new Date(date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            },
            // NEW: Generate a unique device ID
            getDeviceId: () => {
                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    deviceId = Utils.generateId();
                    localStorage.setItem('deviceId', deviceId);
                }
                return deviceId;
            },
            // NEW: Format error message
            formatError: (error) => {
                if (typeof error === 'string') return error;
                if (error instanceof Error) {
                    return error.message || 'Unknown error occurred';
                }
                if (typeof error === 'object') {
                    return JSON.stringify(error, null, 2);
                }
                return String(error);
            },
            // NEW: Check if we can use the app offline
            canUseOffline: () => {
                return APP_STATE.cacheAvailable && 'serviceWorker' in navigator;
            }
        };
        
        // ===== DATABASE MANAGEMENT =====
        const DatabaseManager = {
            initDB: () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('FujiSeatDB', 2); // Increased version
                    
                    request.onerror = (event) => {
                        console.error('Database error:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    request.onsuccess = (event) => {
                        APP_STATE.db = event.target.result;
                        console.log('Database initialized successfully');
                        resolve(APP_STATE.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Create object stores for different data types
                        if (!db.objectStoreNames.contains('productionData')) {
                            const productionStore = db.createObjectStore('productionData', { keyPath: 'id' });
                            productionStore.createIndex('date', 'date', { unique: false });
                            productionStore.createIndex('shift', 'shift', { unique: false });
                            productionStore.createIndex('deviceId', 'deviceId', { unique: false });
                            productionStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                        
                        // NEW: Create sync log store
                        if (!db.objectStoreNames.contains('syncLog')) {
                            const syncLogStore = db.createObjectStore('syncLog', { keyPath: 'id' });
                            syncLogStore.createIndex('deviceId', 'deviceId', { unique: false });
                            syncLogStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                        
                        console.log('Database upgraded successfully');
                    };
                });
            },
            
            saveProductionData: (data) => {
                return new Promise((resolve, reject) => {
                    if (!APP_STATE.db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    
                    const transaction = APP_STATE.db.transaction(['productionData'], 'readwrite');
                    const store = transaction.objectStore('productionData');
                    
                    // Generate ID if not exists
                    if (!data.id) {
                        data.id = Utils.generateId();
                    }
                    
                    // Add device ID and timestamp
                    data.deviceId = Utils.getDeviceId();
                    data.timestamp = new Date().toISOString();
                    
                    const request = store.put(data);
                    
                    request.onsuccess = () => {
                        resolve(data);
                        // Update sync status to indicate changes need to be synced
                        SyncManager.updateStatus('syncing', 'Perubahan perlu disinkronkan');
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error saving production data:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            getProductionData: (date, shift) => {
                return new Promise((resolve, reject) => {
                    if (!APP_STATE.db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    
                    const transaction = APP_STATE.db.transaction(['productionData'], 'readonly');
                    const store = transaction.objectStore('productionData');
                    const index = store.index('date');
                    
                    const request = index.getAll(date);
                    
                    request.onsuccess = () => {
                        const results = request.result;
                        // Filter by shift if specified
                        const filtered = shift ? results.filter(item => item.shift === shift) : results;
                        resolve(filtered);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error getting production data:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            // NEW: Get all data that needs to be synced
            getUnsyncedData: () => {
                return new Promise((resolve, reject) => {
                    if (!APP_STATE.db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    
                    const transaction = APP_STATE.db.transaction(['productionData'], 'readonly');
                    const store = transaction.objectStore('productionData');
                    
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const results = request.result;
                        // For now, we'll consider all data as needing sync
                        // In a real app, you would have a 'synced' flag
                        resolve(results);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error getting unsynced data:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            // NEW: Log sync operation
            logSync: (syncData) => {
                return new Promise((resolve, reject) => {
                    if (!APP_STATE.db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    
                    const transaction = APP_STATE.db.transaction(['syncLog'], 'readwrite');
                    const store = transaction.objectStore('syncLog');
                    
                    const logEntry = {
                        id: Utils.generateId(),
                        deviceId: Utils.getDeviceId(),
                        timestamp: new Date().toISOString(),
                        status: syncData.status,
                        error: syncData.error || null
                    };
                    
                    const request = store.put(logEntry);
                    
                    request.onsuccess = () => {
                        resolve(logEntry);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error logging sync:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }
        };
        
        // ===== PWA FUNCTIONS =====
        const PWA = {
            init: async () => {
                try {
                    // Register service worker
                    const registration = await ServiceWorkerManager.register();
                    
                    // Check cache status
                    ServiceWorkerManager.checkCacheStatus();
                    
                    // Listen for install prompt
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        APP_STATE.deferredPrompt = e;
                        
                        // Show install prompt after delay
                        setTimeout(() => {
                            if (!APP_STATE.installPromptShown && !window.matchMedia('(display-mode: standalone)').matches) {
                                PWA.showInstallPrompt();
                            }
                        }, APP_CONFIG.installPromptDelay);
                    });
                    
                    // Listen for app installed
                    window.addEventListener('appinstalled', () => {
                        APP_STATE.installPromptShown = true;
                        PWA.hideInstallPrompt();
                        AppUI.showToast('Aplikasi berhasil diinstall!');
                    });
                    
                    // Listen for online/offline status
                    window.addEventListener('online', () => {
                        Utils.checkOnlineStatus();
                    });
                    
                    window.addEventListener('offline', () => {
                        Utils.checkOnlineStatus();
                    });
                    
                    // Check online status periodically
                    setInterval(Utils.checkOnlineStatus, APP_CONFIG.offlineCheckInterval);
                    
                    // Initial online status check
                    Utils.checkOnlineStatus();
                } catch (error) {
                    console.error('PWA initialization error:', error);
                    AppUI.showToast('Gagal menginisialisasi PWA. Beberapa fitur mungkin tidak tersedia.', true);
                }
            },
            
            showInstallPrompt: () => {
                // Implementasi sederhana tanpa modal
                AppUI.showToast('Install aplikasi ini untuk pengalaman yang lebih baik. Klik ikon + di browser Anda.');
            },
            
            hideInstallPrompt: () => {
                // Implementasi sederhana
                console.log('Install prompt hidden');
            },
            
            installApp: () => {
                if (APP_STATE.deferredPrompt) {
                    APP_STATE.deferredPrompt.prompt();
                    
                    APP_STATE.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                            AppUI.showToast('Aplikasi sedang diinstall...');
                        } else {
                            console.log('User dismissed the install prompt');
                        }
                        APP_STATE.deferredPrompt = null;
                    });
                }
            },
            
            isAppInstalled: () => {
                return window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone ||
                       document.referrer.includes('android-app://');
            }
        };
        
        // ===== SYNC MANAGEMENT =====
        const SyncManager = {
            init: () => {
                // Set up periodic sync
                if (APP_STATE.syncInterval) {
                    clearInterval(APP_STATE.syncInterval);
                }
                
                APP_STATE.syncInterval = setInterval(() => {
                    if (APP_STATE.isOnline) {
                        SyncManager.syncData();
                    }
                }, APP_CONFIG.syncInterval);
                
                // Set initial sync status
                SyncManager.updateStatus('synced', 'Tersinkronisasi');
            },
            
            syncData: async () => {
                try {
                    if (!APP_STATE.isOnline) {
                        SyncManager.updateStatus('error', 'Anda sedang offline');
                        return;
                    }
                    
                    SyncManager.updateStatus('syncing', 'Menyinkronkan data...');
                    
                    // Get unsynced data
                    const unsyncedData = await DatabaseManager.getUnsyncedData();
                    
                    // In a real app, you would send this data to a server
                    // For this demo, we'll simulate a successful sync
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Log successful sync
                    await DatabaseManager.logSync({
                        status: 'success',
                        dataCount: unsyncedData.length
                    });
                    
                    // Update last sync time
                    APP_STATE.lastSyncTime = new Date();
                    APP_STATE.syncStatus = 'synced';
                    APP_STATE.syncErrorCount = 0;
                    
                    SyncManager.updateStatus('synced', 'Tersinkronisasi');
                    AppUI.showToast('Data berhasil disinkronkan');
                } catch (error) {
                    console.error('Sync error:', error);
                    
                    // Log failed sync
                    await DatabaseManager.logSync({
                        status: 'error',
                        error: Utils.formatError(error)
                    });
                    
                    APP_STATE.syncStatus = 'error';
                    APP_STATE.syncErrorCount++;
                    
                    SyncManager.updateStatus('error', 'Gagal menyinkronkan');
                    AppUI.showToast(`Gagal menyinkronkan data: ${Utils.formatError(error)}`, true);
                    
                    // If too many sync errors, show a more detailed message
                    if (APP_STATE.syncErrorCount >= 3) {
                        AppUI.showToast('Beberapa data gagal disinkronkan. Periksa koneksi internet Anda.', true);
                    }
                }
            },
            
            // NEW: Update sync status UI
            updateStatus: (status, message) => {
                if (!DOM.syncStatus || !DOM.syncStatusText) return;
                
                DOM.syncStatus.className = 'sync-status';
                DOM.syncStatusText.textContent = message;
                
                switch(status) {
                    case 'syncing':
                        DOM.syncStatus.classList.add('syncing');
                        APP_STATE.syncStatus = 'syncing';
                        break;
                    case 'synced':
                        DOM.syncStatus.classList.add('synced');
                        APP_STATE.syncStatus = 'synced';
                        break;
                    case 'error':
                        DOM.syncStatus.classList.add('error');
                        APP_STATE.syncStatus = 'error';
                        break;
                    default:
                        DOM.syncStatusText.textContent = 'Sinkronisasi...';
                        APP_STATE.syncStatus = 'syncing';
                }
            },
            
            // NEW: Force sync
            forceSync: () => {
                if (APP_STATE.isOnline) {
                    SyncManager.syncData();
                } else {
                    AppUI.showToast('Tidak dapat menyinkronkan saat offline', true);
                }
            }
        };
        
        // ===== ERROR HANDLER =====
        const ErrorHandler = {
            // NEW: Handle errors with user-friendly messages
            handleError: (error, context = '') => {
                console.error(`Error in ${context}:`, error);
                
                const errorMessage = Utils.formatError(error);
                
                // Show error modal for critical errors
                if (context.includes('capture') || context.includes('import')) {
                    this.showErrorModal(errorMessage, context);
                } else {
                    // Show toast for less critical errors
                    AppUI.showToast(`Terjadi kesalahan: ${errorMessage}`, true);
                }
                
                // Log error for debugging
                this.logError(error, context);
            },
            
            // NEW: Show error modal
            showErrorModal: (message, context) => {
                if (DOM.errorMessage) {
                    DOM.errorMessage.textContent = `Terjadi kesalahan saat ${context}:`;
                }
                
                if (DOM.errorDetails) {
                    DOM.errorDetails.textContent = message;
                }
                
                if (DOM.errorModal) {
                    DOM.errorModal.classList.add('active');
                }
            },
            
            // NEW: Log error for debugging
            logError: (error, context) => {
                const errorLog = {
                    timestamp: new Date().toISOString(),
                    context: context,
                    error: Utils.formatError(error),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                console.error('Error logged:', errorLog);
                
                // In a real app, you would send this to a logging service
                // For now, we'll just store it in localStorage
                const errorLogs = JSON.parse(localStorage.getItem('errorLogs') || '[]');
                errorLogs.push(errorLog);
                
                // Keep only the last 50 errors
                if (errorLogs.length > 50) {
                    errorLogs.shift();
                }
                
                localStorage.setItem('errorLogs', JSON.stringify(errorLogs));
            }
        };
        
        // ===== CORE APPLICATION FUNCTIONS =====
        const AppCore = {
            init: async () => {
                try {
                    // Initialize database
                    await DatabaseManager.initDB();
                    
                    // Initialize PWA
                    await PWA.init();
                    
                    // Initialize sync manager
                    SyncManager.init();
                    
                    // Set up enter button
                    if (DOM.enterButton) {
                        DOM.enterButton.addEventListener('click', AppCore.handleEnterButtonClick);
                    }
                    
                    // Initialize the rest of the app
                    AppCore.initializeMainApp();
                } catch (error) {
                    ErrorHandler.handleError(error, 'AppCore.init');
                    AppUI.showToast('Gagal menginisialisasi aplikasi. Silakan muat ulang halaman.', true);
                }
            },
            
            initializeMainApp: () => {
                AppCore.updateDate();
                AppCore.loadDataFromLocalStorage();
                AppCore.initializeTables();
                AppCore.setupEventListeners();
                AppCore.setupAutoSave();
                
                if (DOM.progressBar) {
                    window.addEventListener('scroll', AppCore.updateProgressBar);
                }
                
                document.addEventListener('keydown', AppCore.handleKeyboard);
                
                // Inisialisasi tab
                if (DOM.tabs) {
                    DOM.tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            const tabName = tab.getAttribute('data-tab');
                            AppUI.switchTab(tabName);
                        });
                    });
                }
            },
            
            updateDate: () => {
                const now = new Date();
                DOM.currentDate.textContent = Utils.formatDate(now);
                
                // Update table footer date
                if (DOM.tableFooterDate) {
                    const day = now.getDate().toString().padStart(2, '0');
                    const month = now.toLocaleString('id-ID', { month: 'short' }).toUpperCase();
                    const year = now.getFullYear().toString().slice(-2);
                    DOM.tableFooterDate.textContent = `${day}-${month}-${year}`;
                }
            },
            
            initializeTables: () => {
                AppCore.initializeMainTable();
                AppCore.initializeSecondTable();
                AppCore.initializeThirdTable();
                AppCore.setupEventDelegation();
                AppCore.updateResultsDisplay();
            },
            
            initializeMainTable: () => {
                if (!DOM.mainTableBody) return;
                
                DOM.mainTableBody.innerHTML = '';
                
                for (let i = 0; i < N; i++) {
                    AppCore.createTableRow('main', i);
                }
            },
            
            initializeSecondTable: () => {
                if (!DOM.secondTableBody) return;
                
                DOM.secondTableBody.innerHTML = '';
                
                for (let i = 0; i < N; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="kode-inject" data-label="Kode Inject">${KODE_INJECT[i]}</td>
                        <td data-label="STDRT PACK" aria-label="STDRT PACK ${KODE_INJECT[i]}">${STDRT_PACK[i]}</td>
                        <td data-label="ACT /BOX">
                            <input type="text" 
                                   class="act-box-input input-modern" 
                                   data-index="${i}" 
                                   value="${APP_STATE.inputValues.actBox[i] || ''}" 
                                   min="0" 
                                   max="9999" 
                                   aria-label="ACT Box ${KODE_INJECT[i]}" 
                                   placeholder="Contoh: 10,20,30">
                        </td>
                        <td class="act-qty-cell-2 result-cell" 
                            data-label="ACT QTY" 
                            id="act-qty-2-${i}" 
                            aria-label="ACT QTY 2 ${KODE_INJECT[i]}" 
                            title="STDRT PACK * ACT/BOX">
                            ${APP_STATE.actQtyValues[i] || '-'}
                        </td>`;
                    DOM.secondTableBody.appendChild(row);
                }
                
                // Setelah tabel dibuat, atur event listener untuk input ACT/BOX
                AppCore.setupActBoxInputFormatting();
            },
            
            initializeThirdTable: () => {
                if (!DOM.thirdTableBody) return;
                
                DOM.thirdTableBody.innerHTML = '';
                
                for (let i = 0; i < N; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="kode-inject" data-label="Kode Inject">${KODE_INJECT[i]}</td>
                        <td class="stock-reguler-cell result-cell" data-label="Stock Reguler" id="stock-reguler-${i}">${APP_STATE.actQtyValues[i] || 0}</td>
                        <td data-label="Anzen Stock"><input type="number" class="anzen-stock-input input-modern" data-index="${i}" value="${APP_STATE.inputValues.anzenStock[i] || ''}" min="0" aria-label="Anzen Stock ${KODE_INJECT[i]}"></td>
                        <td data-label="F/C 2D"><input type="number" class="fc2d-input input-modern" data-index="${i}" value="${APP_STATE.inputValues.fc2d[i] || ''}" min="0" max="999999" aria-label="F/C 2D ${KODE_INJECT[i]}"></td>
                        <td class="kekuatan-stock-cell result-cell" data-label="Kekuatan Stock /Day" id="kekuatan-stock-${i}">${APP_STATE.kekuatanStockValues[i] || '-'}</td>
                        <td class="kekuatan-anzen-cell result-cell" data-label="Kekuatan Anzen Stock /Day" id="kekuatan-anzen-${i}">${APP_STATE.kekuatanAnzenValues[i] || '-'}</td>`;
                    DOM.thirdTableBody.appendChild(row);
                }
            },
            
            setupActBoxInputFormatting: () => {
                // Tambahkan event listener untuk setiap input ACT/BOX
                document.querySelectorAll('.act-box-input').forEach(input => {
                    // Event listener untuk input
                    input.addEventListener('input', function() {
                        // Simpan posisi kursor
                        const cursorPosition = this.selectionStart;
                        let value = this.value;
                        
                        // Hanya proses jika ada perubahan
                        if (value === '') {
                            // Update nilai di state jika kosong
                            const idx = parseInt(this.dataset.index);
                            if (!isNaN(idx)) {
                                APP_STATE.inputValues.actBox[idx] = '';
                                AppCore.calculateActQty(idx);
                                AppCore.debounceSave();
                                AppCore.updateResultsDisplay();
                            }
                            return;
                        }
                        
                        // Periksa apakah karakter terakhir adalah koma
                        const lastChar = value.charAt(value.length - 1);
                        const endsWithComma = lastChar === ',';
                        
                        // Hapus semua karakter non-angka dan non-koma
                        value = value.replace(/[^0-9,]/g, '');
                        
                        // Jika input berakhir dengan koma, pastikan koma tetap ada
                        if (endsWithComma && value.charAt(value.length - 1) !== ',') {
                            value += ',';
                        }
                        
                        // Proses koma ganda atau koma di awal
                        const parts = value.split(',');
                        const validParts = [];
                        
                        // Proses bagian pertama (sebelum koma pertama)
                        if (parts.length > 0 && parts[0].trim() !== '') {
                            validParts.push(parts[0].trim());
                        }
                        
                        // Proses bagian selanjutnya (setelah koma)
                        for (let i = 1; i < parts.length; i++) {
                            const part = parts[i].trim();
                            if (part !== '') {
                                validParts.push(part);
                            }
                        }
                        
                        // Rekonstruksi nilai
                        if (validParts.length > 0) {
                            value = validParts.join(',');
                            
                            // Jika input asli berakhir dengan koma, pastikan hasil juga berakhir dengan koma
                            if (endsWithComma && !value.endsWith(',')) {
                                value += ',';
                            }
                        } else {
                            value = '';
                        }
                        
                        // Update nilai input
                        this.value = value;
                        
                        // Kembalikan posisi kursor (dengan penyesuaian jika perlu)
                        const newCursorPosition = Math.min(cursorPosition, value.length);
                        this.setSelectionRange(newCursorPosition, newCursorPosition);
                        
                        // Dapatkan index dari input
                        const idx = parseInt(this.dataset.index);
                        if (!isNaN(idx)) {
                            // Update nilai di state
                            APP_STATE.inputValues.actBox[idx] = value;
                            
                            // Hitung ACT QTY
                            AppCore.calculateActQty(idx);
                            
                            // Simpan perubahan
                            AppCore.debounceSave();
                            AppCore.updateResultsDisplay();
                        }
                    });
                    
                    // Event listener untuk keydown untuk menangani koma
                    input.addEventListener('keydown', function(e) {
                        // Jika tombol yang ditekan adalah koma
                        if (e.key === ',') {
                            // Cegah default behavior jika sudah ada koma di akhir
                            if (this.value.endsWith(',')) {
                                e.preventDefault();
                                return;
                            }
                            
                            // Jika input kosong, cegah menambahkan koma di awal
                            if (this.value === '') {
                                e.preventDefault();
                                return;
                            }
                            
                            // Jika kursor berada di awal, cegah menambahkan koma
                            if (this.selectionStart === 0) {
                                e.preventDefault();
                                return;
                            }
                            
                            // Jika karakter sebelum kursor adalah koma, cegah menambahkan koma ganda
                            if (this.value.charAt(this.selectionStart - 1) === ',') {
                                e.preventDefault();
                                return;
                            }
                        }
                    });
                    
                    // Tambahkan event listener untuk blur
                    input.addEventListener('blur', function() {
                        let value = this.value;
                        
                        // Jika input kosong, biarkan kosong
                        if (value === '') return;
                        
                        // Hapus semua karakter non-angka dan non-koma
                        value = value.replace(/[^0-9,]/g, '');
                        
                        // Hapus koma di akhir jika ada
                        if (value.endsWith(',')) {
                            value = value.substring(0, value.length - 1);
                        }
                        
                        // Pisahkan menjadi bagian-bagian berdasarkan koma
                        const parts = value.split(',');
                        
                        // Proses setiap bagian untuk memastikan valid
                        const validParts = [];
                        for (const part of parts) {
                            if (part.trim() !== '') {
                                validParts.push(part.trim());
                            }
                        }
                        
                        value = validParts.join(',');
                        
                        // Update nilai input
                        this.value = value;
                        
                        // Dapatkan index dari input
                        const idx = parseInt(this.dataset.index);
                        if (!isNaN(idx)) {
                            // Update nilai di state
                            APP_STATE.inputValues.actBox[idx] = value;
                            
                            // Hitung ACT QTY
                            AppCore.calculateActQty(idx);
                            
                            // Simpan perubahan
                            AppCore.debounceSave();
                            AppCore.updateResultsDisplay();
                        }
                    });
                    
                    // Tambahkan event listener untuk paste
                    input.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        
                        // Hapus semua karakter non-angka dan non-koma
                        const sanitizedText = pastedText.replace(/[^0-9,]/g, '');
                        
                        // Dapatkan posisi kursor saat ini
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        
                        // Dapatkan nilai input saat ini
                        const currentValue = this.value;
                        
                        // Buat nilai baru dengan menambahkan teks yang disisipkan
                        let newValue = currentValue.substring(0, start) + sanitizedText + currentValue.substring(end);
                        
                        // Proses nilai baru untuk memastikan format yang valid
                        const parts = newValue.split(',');
                        const validParts = [];
                        
                        for (const part of parts) {
                            if (part.trim() !== '') {
                                validParts.push(part.trim());
                            }
                        }
                        
                        newValue = validParts.join(',');
                        
                        // Update nilai input
                        this.value = newValue;
                        
                        // Update posisi kursor
                        const newPosition = start + sanitizedText.length;
                        this.setSelectionRange(newPosition, newPosition);
                        
                        // Trigger input event untuk memproses nilai baru
                        const event = new Event('input', { bubbles: true });
                        this.dispatchEvent(event);
                    });
                });
            },
            
            setupEventDelegation: () => {
                const handleInput = Utils.debounce((e) => {
                    if (!e.target.matches('input[type="number"], input[type="text"]')) return;
                    
                    const idx = parseInt(e.target.dataset.index);
                    if (isNaN(idx)) return;
                    
                    const cls = e.target.classList[0];
                    let value = e.target.value;
                    
                    // Jika ini adalah input ACT/BOX, lewati validasi di sini
                    if (cls.includes('act-box')) {
                        return; // Biarkan fungsi khusus menanganinya
                    }
                    
                    if (cls.includes('fc-2d')) {
                        value = Utils.validateDecimalInput(value, 999999, 0);
                    } else {
                        value = Utils.validateNumberInput(value, e.target.max ? parseInt(e.target.max) : 999999, 0);
                    }
                    
                    e.target.value = value;
                    
                    if (cls.includes('stock-awal') || cls.includes('produksi') || cls.includes('surcip') || cls.includes('sunter') || cls.includes('kiic')) {
                        APP_STATE.inputValues[cls.replace('-input', '')][idx] = value;
                        AppCore.calculateGap(idx);
                    } else if (cls.includes('anzen-stock')) {
                        APP_STATE.inputValues[cls.replace('-input', '')][idx] = value;
                        AppCore.calculateKekuatanStock(idx);
                    } else if (cls.includes('fc2d')) {
                        APP_STATE.inputValues.fc2d[idx] = value;
                        AppCore.calculateKekuatanStock(idx);
                    }
                    
                    AppCore.debounceSave();
                    AppCore.updateResultsDisplay();
                }, 300);
                
                if (DOM.mainTableContainer) DOM.mainTableContainer.addEventListener('input', handleInput);
                if (DOM.thirdTableContainer) DOM.thirdTableContainer.addEventListener('input', handleInput);
                // Hapus event listener untuk secondTableContainer agar tidak konflik
            },
            
            setupEventListeners: () => {
                if (DOM.enterButton) DOM.enterButton.addEventListener('click', AppCore.handleEnterButtonClick);
                if (DOM.nextButton) DOM.nextButton.addEventListener('click', AppUI.handleNextButtonClick);
                if (DOM.prevButton) DOM.prevButton.addEventListener('click', AppUI.handlePrevButtonClick);
                if (DOM.modeToggle) DOM.modeToggle.addEventListener('change', AppUI.handleModeToggleChange);
                if (DOM.fileInput) DOM.fileInput.addEventListener('change', (e) => {
                    ExcelManager.importExcel(e.target.files);
                });
                if (DOM.fileInputThird) DOM.fileInputThird.addEventListener('change', (e) => {
                    ExcelManager.importExcelThirdTable(e.target.files);
                });
                if (DOM.modalCancelButton) DOM.modalCancelButton.addEventListener('click', AppUI.closeModal);
                if (DOM.modalConfirmButton) DOM.modalConfirmButton.addEventListener('click', () => {
                    AppCore.resetData();
                    AppUI.closeModal();
                });
                if (DOM.saveExcelButton) DOM.saveExcelButton.addEventListener('click', ExcelManager.saveToExcel);
                if (DOM.importExcelButton) DOM.importExcelButton.addEventListener('click', () => {
                    if (APP_STATE.currentView === 'third') {
                        DOM.fileInputThird.click();
                    } else {
                        DOM.fileInput.click();
                    }
                });
                if (DOM.resetButton) DOM.resetButton.addEventListener('click', AppUI.confirmReset);
                
                // NEW: Add sync status click handler
                if (DOM.syncStatus) {
                    DOM.syncStatus.addEventListener('click', () => {
                        SyncManager.forceSync();
                    });
                }
                
                // NEW: Add retry connection button handler
                if (DOM.retryConnectionButton) {
                    DOM.retryConnectionButton.addEventListener('click', () => {
                        Utils.checkOnlineStatus();
                    });
                }
                
                // NEW: Add error modal close button handler
                if (DOM.errorModalCloseButton) {
                    DOM.errorModalCloseButton.addEventListener('click', () => {
                        if (DOM.errorModal) {
                            DOM.errorModal.classList.remove('active');
                        }
                    });
                }
            },
            
            setupAutoSave: () => {
                if (APP_STATE.autoSaveInterval) {
                    clearInterval(APP_STATE.autoSaveInterval);
                }
                
                APP_STATE.autoSaveInterval = setInterval(() => {
                    if (AppCore.saveDataToLocalStorage()) {
                        AppUI.showToast('Data tersimpan otomatis');
                    }
                }, APP_CONFIG.autoSaveInterval);
            },
            
            debounceSave: () => {
                clearTimeout(APP_STATE.saveTimeout);
                APP_STATE.saveTimeout = setTimeout(() => {
                    if (AppCore.saveDataToLocalStorage()) {
                        AppUI.showToast('Data tersimpan');
                    }
                }, APP_CONFIG.saveDelay);
            },
            
            processActBoxInput: (value) => {
                // Jika input kosong, return 0
                if (!value || value.trim() === '') return 0;
                
                // Pisahkan input berdasarkan koma
                const parts = value.split(',');
                
                // Konversi setiap bagian menjadi angka dan jumlahkan
                let sum = 0;
                for (const part of parts) {
                    // Trim whitespace
                    const trimmedPart = part.trim();
                    
                    // Skip jika bagian kosong
                    if (trimmedPart === '') continue;
                    
                    // Konversi ke angka
                    const num = parseFloat(trimmedPart);
                    
                    // Tambahkan ke sum jika valid
                    if (!isNaN(num)) {
                        sum += num;
                    }
                }
                
                return sum;
            },
            
            calculateActQty: (i) => {
                // Ambil nilai input ACT/BOX
                const actBoxInput = APP_STATE.inputValues.actBox[i] || '';
                
                // Proses input untuk mendapatkan jumlah total
                const totalActBox = AppCore.processActBoxInput(actBoxInput);
                
                // Hitung ACT QTY
                const actQty = STDRT_PACK[i] * totalActBox;
                APP_STATE.actQtyValues[i] = isNaN(actQty) ? 0 : actQty;
                
                const cell2 = document.getElementById(`act-qty-2-${i}`);
                if (cell2) {
                    cell2.textContent = APP_STATE.actQtyValues[i];
                    cell2.classList.toggle('positive', APP_STATE.actQtyValues[i] > 0);
                    cell2.classList.toggle('zero', APP_STATE.actQtyValues[i] === 0);
                }
                
                AppCore.calculateGap(i);
                AppCore.updateStockRegulerValue(i); // Perbarui stock reguler di tabel ketiga
            },
            
            calculateGap: (i) => {
                const sa = parseInt(APP_STATE.inputValues.stockAwal[i] || 0);
                const p = parseInt(APP_STATE.inputValues.produksi[i] || 0);
                const s = parseInt(APP_STATE.inputValues.surcip[i] || 0);
                const su = parseInt(APP_STATE.inputValues.sunter[i] || 0);
                const k = parseInt(APP_STATE.inputValues.kiic[i] || 0);
                const aq = APP_STATE.actQtyValues[i] || 0;
                
                // Perbaikan rumus GAP: ACT QTY - (STOCK AWAL + PRODUKSI - SURCIP - SUNTER - KIIC)
                const gap = aq - (sa + p - s - su - k);
                APP_STATE.gapValues[i] = isNaN(gap) ? 0 : gap;
                
                const cell = document.getElementById(`gap-${i}`);
                if (cell) {
                    cell.textContent = APP_STATE.gapValues[i];
                    cell.classList.remove('positive', 'negative', 'zero');
                    if (APP_STATE.gapValues[i] > 0) cell.classList.add('positive');
                    else if (APP_STATE.gapValues[i] < 0) cell.classList.add('negative');
                    else cell.classList.add('zero');
                }
            },
            
            calculateKekuatanStock: (i) => {
                const stockReguler = parseFloat(APP_STATE.actQtyValues[i] || 0); // Ambil dari ACT QTY
                const anzenStock = parseFloat(APP_STATE.inputValues.anzenStock[i] || 0);
                const fc2d = parseFloat(APP_STATE.inputValues.fc2d[i] || 0); // Ambil dari input manual
                
                // Hitung KEKUATAN STOCK /DAY berdasarkan rumus STOCK REGULER / F/C 2D
                if (fc2d > 0 && !isNaN(fc2d)) {
                    APP_STATE.kekuatanStockValues[i] = stockReguler / fc2d;
                    APP_STATE.kekuatanAnzenValues[i] = anzenStock / fc2d;
                } else {
                    APP_STATE.kekuatanStockValues[i] = 0;
                    APP_STATE.kekuatanAnzenValues[i] = 0;
                }
                
                const kekuatanStockCell = document.getElementById(`kekuatan-stock-${i}`);
                const kekuatanAnzenCell = document.getElementById(`kekuatan-anzen-${i}`);
                
                if (kekuatanStockCell) {
                    kekuatanStockCell.textContent = isNaN(APP_STATE.kekuatanStockValues[i]) ? '-' : APP_STATE.kekuatanStockValues[i].toFixed(2);
                    kekuatanStockCell.classList.toggle('positive', APP_STATE.kekuatanStockValues[i] > 0);
                    kekuatanStockCell.classList.toggle('zero', APP_STATE.kekuatanStockValues[i] === 0);
                }
                
                if (kekuatanAnzenCell) {
                    kekuatanAnzenCell.textContent = isNaN(APP_STATE.kekuatanAnzenValues[i]) ? '-' : APP_STATE.kekuatanAnzenValues[i].toFixed(2);
                    kekuatanAnzenCell.classList.toggle('positive', APP_STATE.kekuatanAnzenValues[i] > 0);
                    kekuatanAnzenCell.classList.toggle('zero', APP_STATE.kekuatanAnzenValues[i] === 0);
                }
            },
            
            updateStockRegulerValue: (i) => {
                const stockRegulerCell = document.getElementById(`stock-reguler-${i}`);
                if (stockRegulerCell) {
                    stockRegulerCell.textContent = APP_STATE.actQtyValues[i] || 0;
                }
                
                // Hitung ulang kekuatan stock
                AppCore.calculateKekuatanStock(i);
            },
            
            calculateAllActQty: () => {
                for (let i = 0; i < N; i++) {
                    AppCore.calculateActQty(i);
                }
            },
            
            calculateAllGaps: () => {
                for (let i = 0; i < N; i++) {
                    AppCore.calculateGap(i);
                }
            },
            
            calculateAllKekuatanStock: () => {
                for (let i = 0; i < N; i++) {
                    AppCore.calculateKekuatanStock(i);
                }
            },
            
            updateMainTableActQty: () => {
                for (let i = 0; i < N; i++) {
                    const cell = document.getElementById(`act-qty-${i}`);
                    if (cell && APP_STATE.actQtyValues[i] !== undefined) {
                        cell.textContent = APP_STATE.actQtyValues[i];
                        cell.classList.toggle('positive', APP_STATE.actQtyValues[i] > 0);
                        cell.classList.toggle('zero', APP_STATE.actQtyValues[i] === 0);
                    }
                }
                AppCore.calculateAllGaps();
            },
            
            updateSecondTableActQty: () => {
                for (let i = 0; i < N; i++) {
                    const cell = document.getElementById(`act-qty-2-${i}`);
                    if (cell && APP_STATE.actQtyValues[i] !== undefined) {
                        cell.textContent = APP_STATE.actQtyValues[i];
                        cell.classList.toggle('positive', APP_STATE.actQtyValues[i] > 0);
                        cell.classList.toggle('zero', APP_STATE.actQtyValues[i] === 0);
                    }
                }
            },
            
            updateResultsDisplay: () => {
                for (let i = 0; i < N; i++) {
                    const aqCell = document.getElementById(`act-qty-${i}`);
                    if (aqCell && APP_STATE.actQtyValues[i] !== undefined) {
                        aqCell.textContent = APP_STATE.actQtyValues[i];
                        aqCell.classList.toggle('positive', APP_STATE.actQtyValues[i] > 0);
                        aqCell.classList.toggle('zero', APP_STATE.actQtyValues[i] === 0);
                    }
                    
                    const gCell = document.getElementById(`gap-${i}`);
                    if (gCell && APP_STATE.gapValues[i] !== undefined) {
                        gCell.textContent = APP_STATE.gapValues[i];
                        gCell.classList.remove('positive', 'negative', 'zero');
                        if (APP_STATE.gapValues[i] > 0) gCell.classList.add('positive');
                        else if (APP_STATE.gapValues[i] < 0) gCell.classList.add('negative');
                        else gCell.classList.add('zero');
                    }
                    
                    const ksCell = document.getElementById(`kekuatan-stock-${i}`);
                    if (ksCell && APP_STATE.kekuatanStockValues[i] !== undefined) {
                        ksCell.textContent = isNaN(APP_STATE.kekuatanStockValues[i]) ? '-' : APP_STATE.kekuatanStockValues[i].toFixed(2);
                        ksCell.classList.toggle('positive', APP_STATE.kekuatanStockValues[i] > 0);
                        ksCell.classList.toggle('zero', APP_STATE.kekuatanStockValues[i] === 0);
                    }
                    
                    const kaCell = document.getElementById(`kekuatan-anzen-${i}`);
                    if (kaCell && APP_STATE.kekuatanAnzenValues[i] !== undefined) {
                        kaCell.textContent = isNaN(APP_STATE.kekuatanAnzenValues[i]) ? '-' : APP_STATE.kekuatanAnzenValues[i].toFixed(2);
                        kaCell.classList.toggle('positive', APP_STATE.kekuatanAnzenValues[i] > 0);
                        kaCell.classList.toggle('zero', APP_STATE.kekuatanAnzenValues[i] === 0);
                    }
                    
                    // Perbarui Stock Reguler di tabel ketiga
                    const stockRegulerCell = document.getElementById(`stock-reguler-${i}`);
                    if (stockRegulerCell) {
                        stockRegulerCell.textContent = APP_STATE.actQtyValues[i] || 0;
                    }
                    
                    // F/C 2D sekarang diambil dari input manual, tidak perlu dihitung otomatis
                }
            },
            
            saveDataToLocalStorage: () => {
                try {
                    AppCore.saveCurrentSheetData();
                    
                    // Prepare data for saving
                    const data = {
                        sheetsData: APP_STATE.sheetsData,
                        lastSaved: new Date().toISOString(),
                        date: new Date().toISOString().split('T')[0], // YYYY-MM-DD format
                        shift: APP_STATE.isNightMode ? 'night' : 'day',
                        deviceId: Utils.getDeviceId() // NEW: Add device ID
                    };
                    
                    // Save to localStorage
                    const dataString = JSON.stringify(data);
                    localStorage.setItem('productionData', dataString);
                    
                    // Save to IndexedDB
                    DatabaseManager.saveProductionData(data)
                        .then(savedData => {
                            AppUI.showToast('Data tersimpan dan disinkronkan');
                            SyncManager.updateStatus('synced', 'Tersinkronisasi');
                        })
                        .catch(error => {
                            console.error('Error saving to IndexedDB:', error);
                            AppUI.showToast('Gagal menyimpan data ke database lokal', true);
                            SyncManager.updateStatus('error', 'Gagal menyimpan');
                        });
                    
                    return true;
                } catch (e) {
                    console.error('LocalStorage Error:', e);
                    AppUI.showToast(`Gagal menyimpan data: ${e.message || 'Storage mungkin penuh.'}`, true);
                    return false;
                }
            },
            
            loadDataFromLocalStorage: () => {
                return new Promise((resolve, reject) => {
                    try {
                        // Get current date in YYYY-MM-DD format
                        const currentDate = new Date().toISOString().split('T')[0];
                        const currentShift = APP_STATE.isNightMode ? 'night' : 'day';
                        
                        // Try to get data from IndexedDB first
                        DatabaseManager.getProductionData(currentDate, currentShift)
                            .then(results => {
                                if (results.length > 0) {
                                    // Use the most recent result
                                    const data = results[results.length - 1];
                                    
                                    if (data.sheetsData) {
                                        APP_STATE.sheetsData = data.sheetsData;
                                        AppCore.loadSheetData();
                                        AppUI.showToast('Data dimuat dari database lokal.');
                                    }
                                } else {
                                    // Fallback to localStorage
                                    const storedData = localStorage.getItem('productionData');
                                    if (storedData) {
                                        const parsedData = JSON.parse(storedData);
                                        if (parsedData.sheetsData) {
                                            APP_STATE.sheetsData = parsedData.sheetsData;
                                            AppCore.loadSheetData();
                                            AppUI.showToast('Data dimuat dari penyimpanan lokal.');
                                        }
                                    }
                                }
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error loading from IndexedDB:', error);
                                
                                // Fallback to localStorage
                                const storedData = localStorage.getItem('productionData');
                                if (storedData) {
                                    const parsedData = JSON.parse(storedData);
                                    if (parsedData.sheetsData) {
                                        APP_STATE.sheetsData = parsedData.sheetsData;
                                        AppCore.loadSheetData();
                                        AppUI.showToast('Data dimuat dari penyimpanan lokal.');
                                    }
                                }
                                resolve();
                            });
                    } catch (e) {
                        console.error('LocalStorage Load Error:', e);
                        AppCore.resetData();
                        reject(e);
                    }
                });
            },
            
            saveCurrentSheetData: () => {
                APP_STATE.sheetsData[APP_STATE.currentSheet] = {
                    inputValues: JSON.parse(JSON.stringify(APP_STATE.inputValues)),
                    actQtyValues: { ...APP_STATE.actQtyValues },
                    gapValues: { ...APP_STATE.gapValues },
                    kekuatanStockValues: { ...APP_STATE.kekuatanStockValues },
                    kekuatanAnzenValues: { ...APP_STATE.kekuatanAnzenValues }
                };
            },
            
            loadSheetData: () => {
                // Jika sheet data tidak ada, buat data kosong
                if (!APP_STATE.sheetsData[APP_STATE.currentSheet]) {
                    APP_STATE.sheetsData[APP_STATE.currentSheet] = {
                        inputValues: {
                            stockAwal: {},
                            produksi: {},
                            surcip: {},
                            sunter: {},
                            kiic: {},
                            actBox: {},
                            stockReguler: {},
                            anzenStock: {},
                            fc2d: {}
                        },
                        actQtyValues: {},
                        gapValues: {},
                        kekuatanStockValues: {},
                        kekuatanAnzenValues: {}
                    };
                }
                
                const sheetData = APP_STATE.sheetsData[APP_STATE.currentSheet];
                APP_STATE.inputValues = JSON.parse(JSON.stringify(sheetData.inputValues || {}));
                APP_STATE.actQtyValues = { ...sheetData.actQtyValues };
                APP_STATE.gapValues = { ...sheetData.gapValues };
                APP_STATE.kekuatanStockValues = { ...sheetData.kekuatanStockValues };
                APP_STATE.kekuatanAnzenValues = { ...sheetData.kekuatanAnzenValues };
                
                // Inisialisasi ulang semua tabel
                AppCore.initializeTables();
                
                // Hitung ulang semua nilai
                AppCore.calculateAllActQty();
                AppCore.calculateAllGaps();
                AppCore.calculateAllKekuatanStock();
                
                // Perbarui tampilan
                AppCore.updateResultsDisplay();
                
                // Tampilkan pesan jika beralih ke mode baru
                if (APP_STATE.isNightMode) {
                    AppUI.showToast('Mode Night aktif. Tabel telah dimuat dengan data baru.');
                } else {
                    AppUI.showToast('Mode Day aktif. Tabel telah dimuat dengan data baru.');
                }
            },
            
            resetData: () => {
                APP_STATE.inputValues = {
                    stockAwal: {},
                    produksi: {},
                    surcip: {},
                    sunter: {},
                    kiic: {},
                    actBox: {},
                    stockReguler: {},
                    anzenStock: {},
                    fc2d: {}
                };
                APP_STATE.actQtyValues = {};
                APP_STATE.gapValues = {};
                APP_STATE.kekuatanStockValues = {};
                APP_STATE.kekuatanAnzenValues = {};
                AppCore.initializeTables();
                AppUI.closeModal();
                AppUI.showToast('Data telah direset.');
            },
            
            handleKeyboard: (e) => {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (AppCore.saveDataToLocalStorage()) {
                        AppUI.showToast('Data disimpan dengan Ctrl+S.');
                    }
                }
            },
            
            updateProgressBar: () => {
                if (!DOM.progressBar) return;
                const winHeight = window.innerHeight;
                const docHeight = document.documentElement.scrollHeight;
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollPercent = (scrollTop / (docHeight - winHeight)) * 100;
                DOM.progressBar.style.width = scrollPercent + '%';
            },
            
            createTableRow: (tableType, index) => {
                const tableBody = document.getElementById(`${tableType}TableBody`);
                if (!tableBody) return;
                
                let rowHtml = '';
                
                switch(tableType) {
                    case 'main':
                        rowHtml = `
                            <td class="kode-inject" data-label="Kode Inject" aria-label="Kode ${KODE_INJECT[index]}">${KODE_INJECT[index]}</td>
                            <td data-label="Stock Awal"><input type="number" class="stock-awal-input input-modern" data-index="${index}" value="${APP_STATE.inputValues.stockAwal[index] || ''}" min="0" max="999999" aria-label="Stock Awal ${KODE_INJECT[index]}"></td>
                            <td data-label="Produksi"><input type="number" class="produksi-input input-modern" data-index="${index}" value="${APP_STATE.inputValues.produksi[index] || ''}" min="0" max="999999" aria-label="Produksi ${KODE_INJECT[index]}"></td>
                            <td data-label="Surcip"><input type="number" class="surcip-input input-modern" data-index="${index}" value="${APP_STATE.inputValues.surcip[index] || ''}" min="0" max="999999" aria-label="Surcip ${KODE_INJECT[index]}"></td>
                            <td data-label="Sunter"><input type="number" class="sunter-input input-modern" data-index="${index}" value="${APP_STATE.inputValues.sunter[index] || ''}" min="0" max="999999" aria-label="Sunter ${KODE_INJECT[index]}"></td>
                            <td data-label="KIIC"><input type="number" class="kiic-input input-modern" data-index="${index}" value="${APP_STATE.inputValues.kiic[index] || ''}" min="0" max="999999" aria-label="KIIC ${KODE_INJECT[index]}"></td>
                            <td class="act-qty-cell result-cell" data-label="ACT QTY" id="act-qty-${index}" aria-label="ACT QTY ${KODE_INJECT[index]}" title="Dihitung dari tabel kedua: STDRT PACK * ACT/BOX">${APP_STATE.actQtyValues[index] || '-'}</td>
                            <td class="gap-cell result-cell" data-label="GAP" id="gap-${index}" aria-label="GAP ${KODE_INJECT[index]}" title="Rumus: ACT QTY - (STOCK AWAL + PRODUKSI - SURCIP - SUNTER - KIIC)">${APP_STATE.gapValues[index] || '-'}</td>`;
                        break;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = rowHtml;
                tableBody.appendChild(row);
            },
            
            handleEnterButtonClick: (e) => {
                DOM.coverScreen.classList.add('hidden');
                setTimeout(() => {
                    DOM.mainApp.style.display = 'block';
                }, 300);
            }
        };
        
        // ===== UI MANAGEMENT =====
        const AppUI = {
            showMainTable: () => {
                if (!DOM.container || !DOM.secondTableWrapper || !DOM.thirdTableWrapper || !DOM.mainTableWrapper || !DOM.prevButton || !DOM.nextButton) return;
                
                // Sembunyikan semua tabel terlebih dahulu
                document.querySelectorAll('.table-wrapper').forEach(wrapper => {
                    wrapper.classList.remove('active', 'previous');
                });
                
                // Tampilkan tabel utama
                DOM.mainTableWrapper.classList.add('active');
                DOM.prevButton.classList.add('hidden');
                DOM.nextButton.textContent = 'Selanjutnya';
                DOM.nextButton.className = 'nav-button next-button';
                DOM.thirdPageImport.classList.add('hidden');
                
                // Perbarui data tabel utama
                AppCore.updateMainTableActQty();
                
                APP_STATE.currentView = 'main';
            },
            
            showSecondTable: () => {
                if (!DOM.container || !DOM.mainTableWrapper || !DOM.secondTableWrapper || !DOM.thirdTableWrapper || !DOM.prevButton || !DOM.nextButton) return;
                
                // Tandai tabel sebelumnya
                DOM.mainTableWrapper.classList.add('previous');
                
                // Sembunyikan tabel utama dan tampilkan tabel kedua
                DOM.mainTableWrapper.classList.remove('active');
                DOM.secondTableWrapper.classList.add('active');
                DOM.prevButton.classList.remove('hidden');
                DOM.nextButton.textContent = 'Selanjutnya';
                DOM.nextButton.className = 'nav-button next-button';
                DOM.thirdPageImport.classList.add('hidden');
                
                // Perbarui data tabel kedua
                AppCore.updateSecondTableActQty();
                
                APP_STATE.currentView = 'second';
            },
            
            showThirdTable: () => {
                if (!DOM.container || !DOM.mainTableWrapper || !DOM.secondTableWrapper || !DOM.thirdTableWrapper || !DOM.prevButton || !DOM.nextButton) return;
                
                // Tandai tabel sebelumnya
                DOM.secondTableWrapper.classList.add('previous');
                
                // Sembunyikan tabel kedua dan tampilkan tabel ketiga
                DOM.secondTableWrapper.classList.remove('active');
                DOM.thirdTableWrapper.classList.add('active');
                DOM.prevButton.classList.remove('hidden');
                DOM.nextButton.textContent = 'Kembali ke Awal';
                DOM.nextButton.className = 'nav-button calculate-button';
                DOM.thirdPageImport.classList.remove('hidden');
                
                // Perbarui data tabel ketiga
                AppCore.calculateAllKekuatanStock();
                
                APP_STATE.currentView = 'third';
            },
            
            switchTab: (tabName) => {
                // Update active tab
                if (DOM.tabs) {
                    DOM.tabs.forEach(tab => {
                        if (tab.getAttribute('data-tab') === tabName) {
                            tab.classList.add('active');
                        } else {
                            tab.classList.remove('active');
                        }
                    });
                }
                
                // Show appropriate table
                if (tabName === 'main') {
                    AppUI.showMainTable();
                } else if (tabName === 'second') {
                    AppUI.showSecondTable();
                } else if (tabName === 'third') {
                    AppUI.showThirdTable();
                }
                
                // Perbarui tampilan untuk memastikan data terbaru ditampilkan
                AppCore.updateResultsDisplay();
            },
            
            handleEnterButtonClick: (e) => {
                DOM.coverScreen.classList.add('hidden');
                setTimeout(() => {
                    DOM.mainApp.style.display = 'block';
                }, 300);
            },
            
            handleNextButtonClick: () => {
                if (APP_STATE.currentView === 'main') {
                    AppUI.showSecondTable();
                    // Update active tab
                    AppUI.switchTab('second');
                } else if (APP_STATE.currentView === 'second') {
                    AppCore.calculateAllActQty();
                    AppUI.showThirdTable();
                    // Update active tab
                    AppUI.switchTab('third');
                } else if (APP_STATE.currentView === 'third') {
                    AppUI.showMainTable();
                    // Update active tab
                    AppUI.switchTab('main');
                }
            },
            
            handlePrevButtonClick: () => {
                if (APP_STATE.currentView === 'second') {
                    AppUI.showMainTable();
                    // Update active tab
                    AppUI.switchTab('main');
                } else if (APP_STATE.currentView === 'third') {
                    AppUI.showSecondTable();
                    // Update active tab
                    AppUI.switchTab('second');
                }
            },
            
            handleModeToggleChange: () => {
                if (!DOM.container) return;
                
                // Simpan data sheet saat ini sebelum berpindah
                AppCore.saveCurrentSheetData();
                
                // Ubah mode
                APP_STATE.isNightMode = DOM.modeToggle.checked;
                document.body.classList.toggle('night-mode', APP_STATE.isNightMode);
                
                // Ubah judul dan icon berdasarkan mode
                if (APP_STATE.isNightMode) {
                    DOM.pageTitle.innerHTML = `<i class="fas fa-moon" id="modeIcon"></i> STOCK PRODUKSI NIGHT`;
                } else {
                    DOM.pageTitle.innerHTML = `<i class="fas fa-sun" id="modeIcon"></i> STOCK PRODUKSI DAY`;
                }
                
                // Pindah ke sheet yang sesuai
                APP_STATE.currentSheet = APP_STATE.isNightMode ? 2 : 1;
                
                // Muat data sheet baru
                AppCore.loadSheetData();
                
                // Perbarui tampilan
                AppCore.updateResultsDisplay();
            },
            
            showToast: (message, isError = false) => {
                if (!DOM.toast) return;
                
                DOM.toastMessage.textContent = message;
                DOM.toast.className = `toast ${isError ? 'error' : ''} show`;
                
                setTimeout(() => {
                    DOM.toast.classList.remove('show');
                }, APP_CONFIG.toastDuration);
            },
            
            showModal: () => {
                if (!DOM.confirmationModal) return;
                DOM.confirmationModal.classList.add('active');
            },
            
            closeModal: () => {
                if (!DOM.confirmationModal) return;
                DOM.confirmationModal.classList.remove('active');
            },
            
            confirmReset: () => {
                const msgEl = document.getElementById('modalMessage');
                if (msgEl) {
                    msgEl.textContent = "Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan.";
                }
                AppUI.showModal();
            }
        };
        
        // ===== EXCEL MANAGEMENT =====
        const ExcelManager = {
            saveToExcel: () => {
                try {
                    ExcelManager.createExcelWithBorders((fileName) => {
                        AppUI.showToast(`File Excel "${fileName}" telah berhasil disimpan.`);
                    });
                } catch (e) {
                    ErrorHandler.handleError(e, 'ExcelManager.saveToExcel');
                }
            },
            
            createExcelWithBorders: (callback) => {
                try {
                    if (!Utils.checkLibraryAvailability('Excel', XLSX)) {
                        throw new Error('Library Excel tidak tersedia.');
                    }
                    
                    const wb = XLSX.utils.book_new();
                    
                    // Buat style untuk border yang lebih tebal
                    const borderStyle = {
                        border: {
                            top: { style: "medium", color: { rgb: "000000" } },
                            left: { style: "medium", color: { rgb: "000000" } },
                            bottom: { style: "medium", color: { rgb: "000000" } },
                            right: { style: "medium", color: { rgb: "000000" } }
                        }
                    };
                    
                    const headerStyle = {
                        font: { bold: true, color: { rgb: "FFFFFF" }, size: 12 },
                        fill: { fgColor: { rgb: "4361EE" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: borderStyle.border
                    };
                    
                    const footerStyle = {
                        font: { bold: false, size: 10 },
                        alignment: { horizontal: "left", vertical: "center" },
                        border: borderStyle.border
                    };
                    
                    // Sheet 1: Production
                    const data1 = [['KODE INJECT', 'STOCK AWAL', 'PRODUKSI', 'SURCIP', 'SUNTER', 'KIIC', 'ACT QTY', 'GAP']];
                    for (let i = 0; i < N; i++) {
                        data1.push([
                            KODE_INJECT[i],
                            APP_STATE.inputValues.stockAwal[i] || '',
                            APP_STATE.inputValues.produksi[i] || '',
                            APP_STATE.inputValues.surcip[i] || '',
                            APP_STATE.inputValues.sunter[i] || '',
                            APP_STATE.inputValues.kiic[i] || '',
                            APP_STATE.actQtyValues[i] || '',
                            APP_STATE.gapValues[i] || ''
                        ]);
                    }
                    
                    // Tambahkan baris kosong dan footer
                    data1.push(['', '', '', '', '', '', '', '']);
                    data1.push(['FM-003 : FM-448 : FJI-PD-38', '', 'Tanggal : 14-OCT-25', '', 'No.Revisi : 00     Hal : 1/1', '', '', '']);
                    
                    // Buat worksheet dengan style
                    const ws1 = XLSX.utils.aoa_to_sheet(data1);
                    
                    // Set column widths - lebih lebar untuk footer tidak terpotong
                    ws1['!cols'] = [
                        { wch: 30 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, 
                        { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }
                    ];
                    
                    // Merge cells untuk footer
                    const footerRowIndex = data1.length - 1;
                    if (!ws1['!merges']) ws1['!merges'] = [];
                    ws1['!merges'].push(
                        { s: { r: footerRowIndex, c: 0 }, e: { r: footerRowIndex, c: 1 } }, // FM-003
                        { s: { r: footerRowIndex, c: 2 }, e: { r: footerRowIndex, c: 3 } }, // Tanggal
                        { s: { r: footerRowIndex, c: 4 }, e: { r: footerRowIndex, c: 7 } }  // No.Revisi
                    );
                    
                    // Terapkan style untuk header
                    for (let col = 0; col < data1[0].length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws1[cellAddress]) ws1[cellAddress] = {};
                        ws1[cellAddress].s = headerStyle;
                    }
                    
                    // Terapkan border untuk semua sel data
                    for (let row = 0; row < data1.length - 2; row++) {
                        for (let col = 0; col < data1[row].length; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            if (!ws1[cellAddress]) ws1[cellAddress] = {};
                            if (!ws1[cellAddress].s) ws1[cellAddress].s = {};
                            ws1[cellAddress].s.border = borderStyle.border;
                            if (row > 0) {
                                ws1[cellAddress].s.alignment = { horizontal: "center", vertical: "center" };
                            }
                        }
                    }
                    
                    // Terapkan style untuk footer (baris terakhir)
                    const footerRow = data1.length - 1;
                    for (let col = 0; col < data1[0].length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: footerRow, c: col });
                        if (!ws1[cellAddress]) ws1[cellAddress] = {};
                        ws1[cellAddress].s = footerStyle;
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws1, 'Production');
                    
                    // Sheet 2: Box Calculation
                    const data2 = [['KODE INJECT', 'STDRT PACK', 'ACT /BOX', 'ACT QTY']];
                    for (let i = 0; i < N; i++) {
                        data2.push([
                            KODE_INJECT[i],
                            STDRT_PACK[i],
                            APP_STATE.inputValues.actBox[i] || '',
                            APP_STATE.actQtyValues[i] || ''
                        ]);
                    }
                    
                    // Tambahkan baris kosong dan footer
                    data2.push(['', '', '', '']);
                    data2.push(['FM-003 : FM-448 : FJI-PD-38', 'Tanggal : 14-OCT-25', '', 'No.Revisi : 00     Hal : 1/1']);
                    
                    const ws2 = XLSX.utils.aoa_to_sheet(data2);
                    
                    // Set column widths - lebih lebar
                    ws2['!cols'] = [
                        { wch: 30 }, { wch: 20 }, { wch: 15 }, { wch: 30 }
                    ];
                    
                    // Merge cells untuk footer
                    const footerRowIndex2 = data2.length - 1;
                    if (!ws2['!merges']) ws2['!merges'] = [];
                    ws2['!merges'].push(
                        { s: { r: footerRowIndex2, c: 2 }, e: { r: footerRowIndex2, c: 3 } }  // No.Revisi merge dengan kolom terakhir
                    );
                    
                    // Terapkan style untuk header
                    for (let col = 0; col < data2[0].length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws2[cellAddress]) ws2[cellAddress] = {};
                        ws2[cellAddress].s = headerStyle;
                    }
                    
                    // Terapkan border untuk semua sel data
                    for (let row = 0; row < data2.length - 2; row++) {
                        for (let col = 0; col < data2[row].length; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            if (!ws2[cellAddress]) ws2[cellAddress] = {};
                            if (!ws2[cellAddress].s) ws2[cellAddress].s = {};
                            ws2[cellAddress].s.border = borderStyle.border;
                            if (row > 0) {
                                ws2[cellAddress].s.alignment = { horizontal: "center", vertical: "center" };
                            }
                        }
                    }
                    
                    // Terapkan style untuk footer
                    const footerRow2 = data2.length - 1;
                    for (let col = 0; col < data2[0].length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: footerRow2, c: col });
                        if (!ws2[cellAddress]) ws2[cellAddress] = {};
                        ws2[cellAddress].s = footerStyle;
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws2, 'Box Calculation');
                    
                    // Sheet 3: Stock Strength
                    const data3 = [['KODE INJECT', 'STOCK REGULER', 'ANZEN STOCK', 'F/C 2D', 'KEKUATAN STOCK /DAY', 'KEKUATAN ANZEN STOCK /DAY']];
                    for (let i = 0; i < N; i++) {
                        data3.push([
                            KODE_INJECT[i],
                            APP_STATE.actQtyValues[i] || '', // Stock Reguler diambil dari ACT QTY
                            APP_STATE.inputValues.anzenStock[i] || '',
                            APP_STATE.inputValues.fc2d[i] || '', // F/C 2D diambil dari input manual
                            APP_STATE.kekuatanStockValues[i] || '',
                            APP_STATE.kekuatanAnzenValues[i] || ''
                        ]);
                    }
                    
                    // Tambahkan baris kosong dan footer
                    data3.push(['', '', '', '', '', '']);
                    data3.push(['FM-003 : FM-448 : FJI-PD-38', '', 'Tanggal : 14-OCT-25', '', 'No.Revisi : 00     Hal : 1/1', '']);
                    
                    const ws3 = XLSX.utils.aoa_to_sheet(data3);
                    
                    // Set column widths - lebih lebar
                    ws3['!cols'] = [
                        { wch: 25 }, { wch: 18 }, { wch: 18 }, { wch: 15 }, { wch: 25 }, { wch: 30 }
                    ];
                    
                    // Merge cells untuk footer
                    const footerRowIndex3 = data3.length - 1;
                    if (!ws3['!merges']) ws3['!merges'] = [];
                    ws3['!merges'].push(
                        { s: { r: footerRowIndex3, c: 0 }, e: { r: footerRowIndex3, c: 1 } }, // FM-003
                        { s: { r: footerRowIndex3, c: 2 }, e: { r: footerRowIndex3, c: 3 } }, // Tanggal
                        { s: { r: footerRowIndex3, c: 4 }, e: { r: footerRowIndex3, c: 5 } }  // No.Revisi
                    );
                    
                    // Terapkan style untuk header
                    for (let col = 0; col < data3[0].length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!ws3[cellAddress]) ws3[cellAddress] = {};
                        ws3[cellAddress].s = headerStyle;
                    }
                    
                    // Terapkan border untuk semua sel data
                    for (let row = 0; row < data3.length - 2; row++) {
                        for (let col = 0; col < data3[row].length; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            if (!ws3[cellAddress]) ws3[cellAddress] = {};
                            if (!ws3[cellAddress].s) ws3[cellAddress].s = {};
                            ws3[cellAddress].s.border = borderStyle.border;
                            if (row > 0) {
                                ws3[cellAddress].s.alignment = { horizontal: "center", vertical: "center" };
                            }
                        }
                    }
                    
                    // Terapkan style untuk footer
                    const footerRow3 = data3.length - 1;
                    for (let col = 0; col < data3[0].length; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: footerRow3, c: col });
                        if (!ws3[cellAddress]) ws3[cellAddress] = {};
                        ws3[cellAddress].s = footerStyle;
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws3, 'Stock Strength');
                    
                    // Simpan file Excel
                    const fileName = `Laporan_Produksi_${APP_STATE.isNightMode ? 'Night' : 'Day'}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    // Panggil callback dengan nama file
                    if (callback) callback(fileName);
                } catch (e) {
                    ErrorHandler.handleError(e, 'ExcelManager.createExcelWithBorders');
                    if (callback) callback(null);
                }
            },
            
            importExcel: (files) => {
                if (!files || files.length === 0) {
                    AppUI.showToast('Tidak ada file yang dipilih.', true);
                    return;
                }
                
                try {
                    if (!Utils.checkLibraryAvailability('Excel', XLSX)) {
                        throw new Error('Library Excel tidak tersedia.');
                    }
                    
                    const file = files[0];
                    if (!file.name.match(/\.(xlsx|xls)$/i)) {
                        throw new Error('File harus berformat .xlsx atau .xls.');
                    }
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('Ukuran file terlalu besar. Maksimal 5MB.');
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                                throw new Error('File Excel tidak memiliki sheet.');
                            }
                            
                            // Cari sheet yang berisi data produksi (biasanya sheet pertama)
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (jsonData.length < 2) {
                                throw new Error('File Excel tidak memiliki data yang cukup.');
                            }
                            
                            // Ambil header
                            const headers = jsonData[0].map(header => 
                                header ? header.toString().trim().toUpperCase().replace(/\s+/g, ' ') : ''
                            );
                            
                            // Pastikan header sesuai dengan yang diharapkan
                            const expectedHeaders = ['KODE INJECT', 'STOCK AWAL', 'PRODUKSI', 'SURCIP', 'SUNTER', 'KIIC'];
                            const hasValidHeaders = expectedHeaders.every(header => headers.includes(header));
                            
                            if (!hasValidHeaders) {
                                throw new Error('Format file Excel tidak sesuai. Pastikan kolom sesuai dengan template: KODE INJECT, STOCK AWAL, PRODUKSI, SURCIP, SUNTER, KIIC');
                            }
                            
                            // Reset data sebelum mengimpor
                            AppCore.resetData();
                            
                            // Proses setiap baris data
                            let importCount = 0;
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (!row || row.length === 0) continue;
                                
                                // Cari kode inject dalam data
                                const kodeInject = row[headers.indexOf('KODE INJECT')] ? 
                                    row[headers.indexOf('KODE INJECT')].toString().trim() : '';
                                const index = KODE_INJECT.indexOf(kodeInject);
                                
                                if (index === -1) continue; // Skip jika kode tidak ditemukan
                                
                                // Validasi data sebelum mengimpor
                                const stockAwal = row[headers.indexOf('STOCK AWAL')] ? 
                                    row[headers.indexOf('STOCK AWAL')].toString() : '';
                                const produksi = row[headers.indexOf('PRODUKSI')] ? 
                                    row[headers.indexOf('PRODUKSI')].toString() : '';
                                const surcip = row[headers.indexOf('SURCIP')] ? 
                                    row[headers.indexOf('SURCIP')].toString() : '';
                                const sunter = row[headers.indexOf('SUNTER')] ? 
                                    row[headers.indexOf('SUNTER')].toString() : '';
                                const kiic = row[headers.indexOf('KIIC')] ? 
                                    row[headers.indexOf('KIIC')].toString() : '';
                                
                                // Validasi bahwa data adalah angka
                                if (stockAwal && isNaN(stockAwal)) {
                                    console.warn(`Invalid stock awal value for ${kodeInject}: ${stockAwal}`);
                                    continue;
                                }
                                if (produksi && isNaN(produksi)) {
                                    console.warn(`Invalid produksi value for ${kodeInject}: ${produksi}`);
                                    continue;
                                }
                                if (surcip && isNaN(surcip)) {
                                    console.warn(`Invalid surcip value for ${kodeInject}: ${surcip}`);
                                    continue;
                                }
                                if (sunter && isNaN(sunter)) {
                                    console.warn(`Invalid sunter value for ${kodeInject}: ${sunter}`);
                                    continue;
                                }
                                if (kiic && isNaN(kiic)) {
                                    console.warn(`Invalid kiic value for ${kodeInject}: ${kiic}`);
                                    continue;
                                }
                                
                                // Isi data dari Excel
                                APP_STATE.inputValues.stockAwal[index] = stockAwal;
                                APP_STATE.inputValues.produksi[index] = produksi;
                                APP_STATE.inputValues.surcip[index] = surcip;
                                APP_STATE.inputValues.sunter[index] = sunter;
                                APP_STATE.inputValues.kiic[index] = kiic;
                                
                                importCount++;
                            }
                            
                            if (importCount === 0) {
                                throw new Error('Tidak ada data valid yang dapat diimpor.');
                            }
                            
                            // Perbarui tampilan
                            AppCore.initializeTables();
                            AppCore.saveCurrentSheetData();
                            AppCore.saveDataToLocalStorage();
                            
                            AppUI.showToast(`Berhasil mengimpor ${importCount} data dari Excel.`);
                        } catch (error) {
                            ErrorHandler.handleError(error, 'ExcelManager.importExcel.processData');
                        } finally {
                            DOM.fileInput.value = '';
                        }
                    };
                    
                    reader.onerror = () => {
                        ErrorHandler.handleError(new Error('Gagal membaca file Excel.'), 'ExcelManager.importExcel.readFile');
                    };
                    
                    reader.readAsArrayBuffer(file);
                } catch (e) {
                    ErrorHandler.handleError(e, 'ExcelManager.importExcel');
                }
            },
            
            importExcelThirdTable: (files) => {
                if (!files || files.length === 0) {
                    AppUI.showToast('Tidak ada file yang dipilih.', true);
                    return;
                }
                
                try {
                    if (!Utils.checkLibraryAvailability('Excel', XLSX)) {
                        throw new Error('Library Excel tidak tersedia.');
                    }
                    
                    const file = files[0];
                    if (!file.name.match(/\.(xlsx|xls)$/i)) {
                        throw new Error('File harus berformat .xlsx atau .xls.');
                    }
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('Ukuran file terlalu besar. Maksimal 5MB.');
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                                throw new Error('File Excel tidak memiliki sheet.');
                            }
                            
                            // Cari sheet yang berisi data produksi (biasanya sheet pertama)
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (jsonData.length < 2) {
                                throw new Error('File Excel tidak memiliki data yang cukup.');
                            }
                            
                            // Ambil header
                            const headers = jsonData[0].map(header => 
                                header ? header.toString().trim().toUpperCase().replace(/\s+/g, ' ') : ''
                            );
                            
                            // Pastikan header sesuai dengan yang diharapkan untuk halaman ketiga
                            const expectedHeaders = ['KODE INJECT', 'STOCK REGULER', 'ANZEN STOCK', 'F/C 2D'];
                            const hasValidHeaders = expectedHeaders.every(header => headers.includes(header));
                            
                            if (!hasValidHeaders) {
                                throw new Error('Format file Excel tidak sesuai. Pastikan kolom sesuai dengan template: KODE INJECT, STOCK REGULER, ANZEN STOCK, F/C 2D');
                            }
                            
                            // Proses setiap baris data
                            let importCount = 0;
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (!row || row.length === 0) continue;
                                
                                // Cari kode inject dalam data
                                const kodeInject = row[headers.indexOf('KODE INJECT')] ? 
                                    row[headers.indexOf('KODE INJECT')].toString().trim() : '';
                                const index = KODE_INJECT.indexOf(kodeInject);
                                
                                if (index === -1) continue; // Skip jika kode tidak ditemukan
                                
                                // Validasi data sebelum mengimpor
                                const stockReguler = row[headers.indexOf('STOCK REGULER')] ? 
                                    row[headers.indexOf('STOCK REGULER')].toString() : '';
                                const anzenStock = row[headers.indexOf('ANZEN STOCK')] ? 
                                    row[headers.indexOf('ANZEN STOCK')].toString() : '';
                                const fc2d = row[headers.indexOf('F/C 2D')] ? 
                                    row[headers.indexOf('F/C 2D')].toString() : '';
                                
                                // Validasi bahwa data adalah angka
                                if (stockReguler && isNaN(stockReguler)) {
                                    console.warn(`Invalid stock reguler value for ${kodeInject}: ${stockReguler}`);
                                    continue;
                                }
                                if (anzenStock && isNaN(anzenStock)) {
                                    console.warn(`Invalid anzen stock value for ${kodeInject}: ${anzenStock}`);
                                    continue;
                                }
                                if (fc2d && isNaN(fc2d)) {
                                    console.warn(`Invalid F/C 2D value for ${kodeInject}: ${fc2d}`);
                                    continue;
                                }
                                
                                // Isi data dari Excel
                                APP_STATE.actQtyValues[index] = stockReguler;
                                APP_STATE.inputValues.anzenStock[index] = anzenStock;
                                APP_STATE.inputValues.fc2d[index] = fc2d;
                                
                                importCount++;
                            }
                            
                            if (importCount === 0) {
                                throw new Error('Tidak ada data valid yang dapat diimpor.');
                            }
                            
                            // Perbarui tampilan
                            AppCore.initializeThirdTable();
                            AppCore.calculateAllKekuatanStock();
                            AppCore.saveCurrentSheetData();
                            AppCore.saveDataToLocalStorage();
                            
                            AppUI.showToast(`Berhasil mengimpor ${importCount} data dari Excel untuk tabel Kekuatan Stock.`);
                        } catch (error) {
                            ErrorHandler.handleError(error, 'ExcelManager.importExcelThirdTable.processData');
                        } finally {
                            DOM.fileInputThird.value = '';
                        }
                    };
                    
                    reader.onerror = () => {
                        ErrorHandler.handleError(new Error('Gagal membaca file Excel.'), 'ExcelManager.importExcelThirdTable.readFile');
                    };
                    
                    reader.readAsArrayBuffer(file);
                } catch (e) {
                    ErrorHandler.handleError(e, 'ExcelManager.importExcelThirdTable');
                }
            }
        };
        
        // ===== SHARE FUNCTIONS =====
        const ShareManager = {
            captureActiveTable: async () => {
                try {
                    // Check if we're online
                    if (!APP_STATE.isOnline) {
                        throw new Error('Anda sedang offline. Fitur ini memerlukan koneksi internet.');
                    }
                    
                    if (!Utils.checkLibraryAvailability('html2canvas', html2canvas)) {
                        throw new Error('Library html2canvas tidak tersedia.');
                    }
                    
                    // Determine which table to capture based on current view
                    let targetTable, tableTitle, tableId;
                    
                    switch(APP_STATE.currentView) {
                        case 'main':
                            targetTable = document.getElementById('mainTable');
                            tableTitle = 'Laporan Stock Produksi';
                            tableId = 'mainTable';
                            break;
                        case 'second':
                            targetTable = document.getElementById('secondTable');
                            tableTitle = 'Perhitungan Box';
                            tableId = 'secondTable';
                            break;
                        case 'third':
                            targetTable = document.getElementById('thirdTable');
                            tableTitle = 'Kekuatan Stock';
                            tableId = 'thirdTable';
                            break;
                        default:
                            targetTable = document.getElementById('mainTable');
                            tableTitle = 'Laporan Stock Produksi';
                            tableId = 'mainTable';
                    }
                    
                    // Check if the target table exists
                    if (!targetTable) {
                        throw new Error('Tabel tidak ditemukan.');
                    }
                    
                    // Simpan state mode saat ini
                    const originalNightMode = APP_STATE.isNightMode;
                    
                    // Paksa mode terang untuk kualitas gambar terbaik
                    APP_STATE.isNightMode = false;
                    document.body.classList.remove('night-mode');
                    
                    // Buat elemen wrapper sementara untuk menampung tabel
                    const wrapper = document.createElement('div');
                    wrapper.className = 'capture-wrapper';
                    wrapper.style.position = 'absolute';
                    wrapper.style.top = '0';
                    wrapper.style.left = '0';
                    wrapper.style.width = '1200px';
                    wrapper.style.maxWidth = '1200px';
                    wrapper.style.backgroundColor = '#ffffff';
                    wrapper.style.padding = '20px';
                    wrapper.style.boxSizing = 'border-box';
                    wrapper.style.fontFamily = "-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif";
                    wrapper.style.color = '#2b2d42';
                    wrapper.style.zIndex = '10000';
                    wrapper.style.overflow = 'hidden';
                    
                    // Tambahkan header informasi
                    const headerInfo = document.createElement('div');
                    headerInfo.className = 'capture-header';
                    headerInfo.style.backgroundColor = '#ffffff';
                    headerInfo.innerHTML = `
                        <h1>PT FUJI SEAT INDONESIA</h1>
                        <h2>Laporan Data Stock Akhir Proses Div.INJECTION</h2>
                        <h3>${tableTitle}</h3>
                        <p>Shift: ${originalNightMode ? 'NIGHT' : 'DAY'} | Tanggal: ${DOM.currentDate.textContent}</p>
                    `;
                    wrapper.appendChild(headerInfo);
                    
                    // Salin tabel ke wrapper
                    const tableClone = targetTable.cloneNode(true);
                    
                    // Terapkan styling yang konsisten untuk tabel
                    tableClone.style.width = '100%';
                    tableClone.style.borderCollapse = 'collapse';
                    tableClone.style.fontSize = '18px';
                    tableClone.style.marginBottom = '20px';
                    tableClone.style.backgroundColor = '#ffffff';
                    tableClone.style.border = '1px solid #dee2e6';
                    
                    // Styling untuk header tabel
                    const headerCells = tableClone.querySelectorAll('thead th');
                    headerCells.forEach(th => {
                        th.style.backgroundColor = '#4361ee';
                        th.style.color = '#ffffff';
                        th.style.fontWeight = 'bold';
                        th.style.padding = '12px';
                        th.style.textAlign = 'center';
                        th.style.border = '1px solid #4361ee';
                        th.style.fontSize = '18px';
                    });
                    
                    // Styling untuk sel data
                    const dataCells = tableClone.querySelectorAll('tbody td');
                    dataCells.forEach(td => {
                        td.style.padding = '12px';
                        td.style.textAlign = 'center';
                        td.style.borderBottom = '1px solid #dee2e6';
                        td.style.borderLeft = '1px solid #dee2e6';
                        td.style.borderRight = '1px solid #dee2e6';
                        td.style.backgroundColor = '#ffffff';
                        td.style.fontSize = '18px';
                    });
                    
                    // Styling untuk sel dengan khusus
                    const kodeInjectCells = tableClone.querySelectorAll('.kode-inject');
                    kodeInjectCells.forEach(cell => {
                        cell.style.fontWeight = 'bold';
                        cell.style.textAlign = 'left';
                        cell.style.backgroundColor = '#ffffff';
                        cell.style.borderLeft = '1px solid #dee2e6';
                        cell.style.borderRight = '1px solid #dee2e6';
                        cell.style.fontSize = '18px';
                    });
                    
                    const resultCells = tableClone.querySelectorAll('.result-cell');
                    resultCells.forEach(cell => {
                        cell.style.fontWeight = 'bold';
                        cell.style.backgroundColor = '#ffffff';
                        cell.style.borderLeft = '1px solid #dee2e6';
                        cell.style.borderRight = '1px solid #dee2e6';
                        cell.style.fontSize = '18px';
                    });
                    
                    const positiveCells = tableClone.querySelectorAll('.positive');
                    positiveCells.forEach(cell => {
                        cell.style.color = '#06d6a0';
                        cell.style.backgroundColor = '#ffffff';
                        cell.style.borderLeft = '1px solid #dee2e6';
                        cell.style.borderRight = '1px solid #dee2e6';
                        cell.style.fontSize = '18px';
                    });
                    
                    const negativeCells = tableClone.querySelectorAll('.negative');
                    negativeCells.forEach(cell => {
                        cell.style.color = '#ef476f';
                        cell.style.backgroundColor = '#ffffff';
                        cell.style.borderLeft = '1px solid #dee2e6';
                        cell.style.borderRight = '1px solid #dee2e6';
                        cell.style.fontSize = '18px';
                    });
                    
                    const zeroCells = tableClone.querySelectorAll('.zero');
                    zeroCells.forEach(cell => {
                        cell.style.color = '#8d99ae';
                        cell.style.backgroundColor = '#ffffff';
                        cell.style.borderLeft = '1px solid #dee2e6';
                        cell.style.borderRight = '1px solid #dee2e6';
                        cell.style.fontSize = '18px';
                    });
                    
                    wrapper.appendChild(tableClone);
                    
                    // Tambahkan footer informasi
                    const footerInfo = document.createElement('div');
                    footerInfo.className = 'capture-footer';
                    footerInfo.style.backgroundColor = '#ffffff';
                    footerInfo.innerHTML = `
                        <p> 2025 Laporan Produksi Harian - PT Fuji Seat Indonesia</p>
                        <p>Dibuat pada: ${new Date().toLocaleString('id-ID')}</p>
                    `;
                    wrapper.appendChild(footerInfo);
                    
                    // Tambahkan wrapper ke body
                    document.body.appendChild(wrapper);
                    
                    // Fungsi untuk mengunduh file
                    const downloadImage = async (imgData, fileName) => {
                        try {
                            // Buat link download
                            const link = document.createElement('a');
                            link.download = fileName;
                            link.href = imgData;
                            
                            // Tambahkan ke DOM
                            document.body.appendChild(link);
                            
                            // Trigger klik
                            link.click();
                            
                            // Hapus dari DOM
                            document.body.removeChild(link);
                            
                            return true;
                        } catch (error) {
                            console.error('Download error:', error);
                            throw new Error('Gagal mengunduh file.');
                        }
                    };
                    
                    // Fungsi untuk memeriksa ukuran file dan menyesuaikan kualitas jika diperlukan
                    const checkFileSizeAndAdjust = async (canvas, quality, scale) => {
                        try {
                            // Konversi ke JPG dengan kualitas yang diberikan
                            const imgData = canvas.toDataURL('image/jpeg', quality);
                            
                            // Periksa ukuran file dalam bytes
                            const fileSize = Math.round((imgData.length * 0.75) / 1024); // Konversi ke KB
                            
                            // Jika ukuran file masih di bawah batas, kembalikan data
                            if (fileSize <= APP_CONFIG.jpgConfig.maxSize / 1024) {
                                return { success: true, imgData, fileSize };
                            }
                            
                            // Jika masih terlalu besar, kurangi kualitas atau skala
                            if (quality > APP_CONFIG.jpgConfig.minQuality) {
                                const newQuality = Math.max(quality - 0.1, APP_CONFIG.jpgConfig.minQuality);
                                return checkFileSizeAndAdjust(canvas, newQuality, scale);
                            } else if (scale > APP_CONFIG.jpgConfig.minScale) {
                                const newScale = Math.max(scale - 0.5, APP_CONFIG.jpgConfig.minScale);
                                return createCanvasWithScale(newScale);
                            }
                            
                            // Jika masih terlalu besar setelah semua penyesuaian, kompres lebih lanjut
                            return compressImageFurther(canvas);
                        } catch (error) {
                            console.error('File size check error:', error);
                            throw new Error('Gagal memeriksa ukuran file.');
                        }
                    };
                    
                    // Fungsi untuk membuat canvas dengan skala yang diberikan
                    const createCanvasWithScale = async (scale) => {
                        try {
                            // Opsi untuk html2canvas dengan skala yang disesuaikan
                            const options = {
                                backgroundColor: '#ffffff',
                                scale: scale,
                                useCORS: true,
                                logging: false,
                                allowTaint: false,
                                width: wrapper.scrollWidth,
                                height: wrapper.scrollHeight,
                                scrollX: 0,
                                scrollY: 0,
                                letterRendering: true,
                                foreignObjectRendering: false,
                                removeContainer: true,
                                imageTimeout: 15000,
                                onclone: (clonedDoc) => {
                                    // Pastikan semua styling diterapkan dengan benar di clone
                                    const clonedWrapper = clonedDoc.querySelector('.capture-wrapper');
                                    if (clonedWrapper) {
                                        clonedWrapper.style.width = '1200px';
                                        clonedWrapper.style.maxWidth = '1200px';
                                        clonedWrapper.style.backgroundColor = '#ffffff';
                                        
                                        // Terapkan styling ke tabel di clone
                                        const clonedTable = clonedWrapper.querySelector('table');
                                        if (clonedTable) {
                                            clonedTable.style.width = '100%';
                                            clonedTable.style.borderCollapse = 'collapse';
                                            clonedTable.style.backgroundColor = '#ffffff';
                                            clonedTable.style.border = '1px solid #dee2e6';
                                            
                                            // Terapkan styling ke header di clone
                                            const clonedHeaders = clonedTable.querySelectorAll('thead th');
                                            clonedHeaders.forEach(th => {
                                                th.style.backgroundColor = '#4361ee';
                                                th.style.color = '#ffffff';
                                                th.style.fontSize = '18px';
                                                th.style.border = '1px solid #4361ee';
                                            });
                                            
                                            // Terapkan styling ke sel data di clone
                                            const clonedCells = clonedTable.querySelectorAll('tbody td');
                                            clonedCells.forEach(td => {
                                                td.style.borderBottom = '1px solid #dee2e6';
                                                td.style.borderLeft = '1px solid #dee2e6';
                                                td.style.borderRight = '1px solid #dee2e6';
                                                td.style.backgroundColor = '#ffffff';
                                                td.style.fontSize = '18px';
                                            });
                                            
                                            // Terapkan styling ke sel kode inject di clone
                                            const clonedKodeInject = clonedTable.querySelectorAll('.kode-inject');
                                            clonedKodeInject.forEach(cell => {
                                                cell.style.backgroundColor = '#ffffff';
                                                cell.style.borderLeft = '1px solid #dee2e6';
                                                cell.style.borderRight = '1px solid #dee2e6';
                                                cell.style.fontSize = '18px';
                                            });
                                        }
                                        
                                        // Terapkan styling ke header di clone
                                        const clonedHeader = clonedWrapper.querySelector('.capture-header');
                                        if (clonedHeader) {
                                            clonedHeader.style.backgroundColor = '#ffffff';
                                        }
                                        
                                        // Terapkan styling ke footer di clone
                                        const clonedFooter = clonedWrapper.querySelector('.capture-footer');
                                        if (clonedFooter) {
                                            clonedFooter.style.backgroundColor = '#ffffff';
                                        }
                                    }
                                }
                            };
                            
                            const canvas = await html2canvas(wrapper, options);
                            return checkFileSizeAndAdjust(canvas, APP_CONFIG.jpgConfig.initialQuality, scale);
                        } catch (error) {
                            console.error('Canvas creation error:', error);
                            throw new Error('Gagal membuat gambar.');
                        }
                    };
                    
                    // Fungsi untuk kompres gambar lebih lanjut jika diperlukan
                    const compressImageFurther = async (canvas) => {
                        try {
                            // Buat gambar baru dengan kualitas lebih rendah
                            const img = new Image();
                            img.src = canvas.toDataURL('image/jpeg', APP_CONFIG.jpgConfig.minQuality);
                            
                            // Tunggu gambar dimuat
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                            });
                            
                            // Buat canvas baru dengan ukuran yang lebih kecil
                            const newCanvas = document.createElement('canvas');
                            const ctx = newCanvas.getContext('2d');
                            
                            // Hitung ukuran baru (75% dari ukuran asli)
                            const newWidth = canvas.width * 0.75;
                            const newHeight = canvas.height * 0.75;
                            
                            // Set ukuran canvas baru
                            newCanvas.width = newWidth;
                            newCanvas.height = newHeight;
                            
                            // Gambar gambar yang dikompres ke canvas baru
                            ctx.drawImage(img, 0, 0, newWidth, newHeight);
                            
                            // Konversi ke JPG dengan kualitas minimum
                            const imgData = newCanvas.toDataURL('image/jpeg', APP_CONFIG.jpgConfig.minQuality);
                            
                            // Periksa ukuran file
                            const fileSize = Math.round((imgData.length * 0.75) / 1024); // Konversi ke KB
                            
                            return { success: true, imgData, fileSize, compressed: true };
                        } catch (error) {
                            console.error('Image compression error:', error);
                            throw new Error('Gagal mengompres gambar.');
                        }
                    };
                    
                    // Mulai proses pembuatan gambar
                    const result = await createCanvasWithScale(APP_CONFIG.jpgConfig.scale);
                    
                    if (result.success) {
                        // Hapus wrapper sementara
                        if (document.body.contains(wrapper)) {
                            document.body.removeChild(wrapper);
                        }
                        
                        // Kembalikan mode asli
                        APP_STATE.isNightMode = originalNightMode;
                        if (originalNightMode) {
                            document.body.classList.add('night-mode');
                        }
                        
                        // Buat nama file berdasarkan tabel yang aktif
                        const fileName = `Laporan_${tableTitle.replace(/\s+/g, '_')}_${originalNightMode ? 'Night' : 'Day'}_${new Date().toISOString().slice(0, 10)}.jpg`;
                        
                        try {
                            // Unduh gambar
                            await downloadImage(result.imgData, fileName);
                            
                            // Tampilkan pesan sukses
                            const fileSizeMB = (result.fileSize / 1024).toFixed(2);
                            AppUI.showToast(`JPG berhasil diunduh (${fileSizeMB} MB).${result.compressed ? ' Gambar dikompres untuk memenuhi batas ukuran.' : ''}`);
                        } catch (downloadError) {
                            ErrorHandler.handleError(downloadError, 'ShareManager.downloadImage');
                        }
                    } else {
                        throw new Error('Gagal membuat gambar yang memenuhi syarat ukuran.');
                    }
                    
                } catch (e) {
                    ErrorHandler.handleError(e, 'ShareManager.captureActiveTable');
                }
            }
        };
        
        // ===== INISIALISASI APLIKASI =====
        document.addEventListener('DOMContentLoaded', AppCore.init);
    </script>

</body>
</html>
